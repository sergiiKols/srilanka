# üîç –°–†–ê–í–ù–ï–ù–ò–ï –°–¢–ê–†–û–ô –ò –ù–û–í–û–ô –õ–û–ì–ò–ö–ò –ê–†–•–ò–í–ê–¶–ò–ò

## üìã –°–¢–ê–†–ê–Ø –õ–û–ì–ò–ö–ê (–∏–∑ database/07_setup_archive_logic.sql)

### –§—É–Ω–∫—Ü–∏—è soft_delete_property (—Å—Ç—Ä–æ–∫–∏ 153-174):

```sql
CREATE OR REPLACE FUNCTION soft_delete_property(
  property_id UUID,
  user_id BIGINT,
  reason TEXT DEFAULT 'user_deleted'
)
RETURNS BOOLEAN AS $$
BEGIN
  -- –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç
  PERFORM archive_property(property_id, reason, user_id);
  
  -- –£–º–µ–Ω—å—à–∞–µ–º —Å—á—ë—Ç—á–∏–∫ —É tenant
  UPDATE tenants 
  SET saved_properties_count = saved_properties_count - 1
  WHERE telegram_user_id = user_id;
  
  RETURN TRUE;
EXCEPTION
  WHEN OTHERS THEN
    RAISE NOTICE 'Error in soft_delete_property: %', SQLERRM;
    RETURN FALSE;
END;
$$ LANGUAGE plpgsql;
```

### ‚úÖ –ö–õ–Æ–ß–ï–í–´–ï –û–°–û–ë–ï–ù–ù–û–°–¢–ò –°–¢–ê–†–û–ô –õ–û–ì–ò–ö–ò:

1. **–í—ã–∑—ã–≤–∞–µ—Ç –¥—Ä—É–≥—É—é —Ñ—É–Ω–∫—Ü–∏—é**: `PERFORM archive_property()`
2. **–£–º–µ–Ω—å—à–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫**: `UPDATE tenants SET saved_properties_count = saved_properties_count - 1`
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: `EXCEPTION WHEN OTHERS`
4. **–¢—Ä–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞**: property_id, user_id, reason

---

## üÜï –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê (–∏–∑ FIX_ARCHIVE_FUNCTIONS.sql)

### –§—É–Ω–∫—Ü–∏—è soft_delete_property:

```sql
CREATE OR REPLACE FUNCTION soft_delete_property(
    property_id UUID,
    user_id BIGINT,
    reason TEXT DEFAULT 'user_deleted'
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    property_record RECORD;
    days_active_count INTEGER;
BEGIN
    -- –ü–æ–ª—É—á–∞–µ–º –∑–∞–ø–∏—Å—å
    SELECT * INTO property_record
    FROM saved_properties
    WHERE id = property_id 
    AND telegram_user_id = user_id;

    IF NOT FOUND THEN
        RAISE EXCEPTION 'Property not found or access denied';
    END IF;

    -- –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –æ–±—ä–µ–∫—Ç –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
    days_active_count := EXTRACT(DAY FROM (NOW() - property_record.created_at))::INTEGER;

    -- –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç (—Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏!)
    INSERT INTO archived_properties (
        id,
        telegram_user_id,
        latitude,
        longitude,
        title,
        description,
        property_type,
        price,
        currency,
        bedrooms,
        bathrooms,
        amenities,
        photos,
        contact_phone,
        contact_name,
        source_type,
        forward_from_chat_id,
        forward_from_chat_title,
        forward_from_username,
        forward_from_message_id,
        forward_date,
        google_maps_url,
        can_restore,
        archive_reason,
        archived_at,
        archived_by,
        original_created_at,
        original_updated_at,
        days_active
    ) VALUES (
        property_record.id,
        property_record.telegram_user_id,
        property_record.latitude,
        property_record.longitude,
        property_record.title,
        property_record.description,
        property_record.property_type,
        property_record.price,
        property_record.currency,
        property_record.bedrooms,
        property_record.bathrooms,
        property_record.amenities,
        property_record.photos,
        property_record.contact_phone,
        property_record.contact_name,
        property_record.source_type,
        property_record.forward_from_chat_id,
        property_record.forward_from_chat_title,
        property_record.forward_from_username,
        property_record.forward_from_message_id,
        property_record.forward_date,
        property_record.google_maps_url,
        TRUE, -- can_restore
        reason, -- archive_reason
        NOW(), -- archived_at
        user_id, -- archived_by
        property_record.created_at, -- original_created_at
        property_record.updated_at, -- original_updated_at
        days_active_count -- days_active
    );

    -- –£–¥–∞–ª—è–µ–º –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
    DELETE FROM saved_properties
    WHERE id = property_id 
    AND telegram_user_id = user_id;

    RETURN TRUE;
END;
$$;
```

### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–´ –ù–û–í–û–ô –õ–û–ì–ò–ö–ò:

1. **–ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç archive_property()** - –¥—É–±–ª–∏—Ä—É–µ—Ç –∫–æ–¥!
2. **–ù–ï —É–º–µ–Ω—å—à–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫** `saved_properties_count` –≤ —Ç–∞–±–ª–∏—Ü–µ `tenants`! ‚ùå
3. **–ù–ï–¢ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫** EXCEPTION
4. **–î—É–±–ª–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É** –∏–∑ archive_property

---

## ‚ùå –ß–¢–û –°–õ–û–ú–ê–ù–û –í –ù–û–í–û–ô –õ–û–ì–ò–ö–ï:

### 1. –°—á—ë—Ç—á–∏–∫ tenants.saved_properties_count
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ —Å—á—ë—Ç—á–∏–∫ –Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è!

**–ë—ã–ª–æ:**
```sql
UPDATE tenants 
SET saved_properties_count = saved_properties_count - 1
WHERE telegram_user_id = user_id;
```

**–°—Ç–∞–ª–æ:** ‚ùå –≠—Ç–æ–≥–æ –∫–æ–¥–∞ –Ω–µ—Ç!

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤
- –°—á—ë—Ç—á–∏–∫ —Ä–∞—Å—Ç—ë—Ç, –Ω–æ –Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
**–ë—ã–ª–æ:**
```sql
EXCEPTION
  WHEN OTHERS THEN
    RAISE NOTICE 'Error in soft_delete_property: %', SQLERRM;
    RETURN FALSE;
```

**–°—Ç–∞–ª–æ:** ‚ùå –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫!

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü—Ä–∏ –æ—à–∏–±–∫–µ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ª–µ—Ç–∞–µ—Ç —Å exception
- –ù–µ—Ç graceful fallback

### 3. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
**–ë—ã–ª–æ:** –í—ã–∑–æ–≤ `archive_property()` - –æ–¥–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏

**–°—Ç–∞–ª–æ:** –í–µ—Å—å –∫–æ–¥ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω –≤–Ω—É—Ç—Ä–∏ `soft_delete_property`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ù–∞—Ä—É—à–µ–Ω DRY –ø—Ä–∏–Ω—Ü–∏–ø
- –î–≤–∞ –º–µ—Å—Ç–∞ –≥–¥–µ –Ω—É–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –æ–¥–Ω—É –ª–æ–≥–∏–∫—É
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö

---

## üîß –ß–¢–û –ù–£–ñ–ù–û –ò–°–ü–†–ê–í–ò–¢–¨:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

```sql
CREATE OR REPLACE FUNCTION soft_delete_property(
  property_id UUID,
  user_id BIGINT,
  reason TEXT DEFAULT 'user_deleted'
)
RETURNS BOOLEAN AS $$
BEGIN
  -- –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç (–≤—ã–∑—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é)
  PERFORM archive_property(property_id, reason, user_id);
  
  -- –£–º–µ–Ω—å—à–∞–µ–º —Å—á—ë—Ç—á–∏–∫ —É tenant
  UPDATE tenants 
  SET saved_properties_count = saved_properties_count - 1
  WHERE telegram_user_id = user_id;
  
  RETURN TRUE;
EXCEPTION
  WHEN OTHERS THEN
    RAISE NOTICE 'Error in soft_delete_property: %', SQLERRM;
    RETURN FALSE;
END;
$$ LANGUAGE plpgsql;
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –î–æ–ø–æ–ª–Ω–∏—Ç—å –Ω–æ–≤—É—é –ª–æ–≥–∏–∫—É

–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω–µ—Ü –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ (–ø–µ—Ä–µ–¥ `RETURN TRUE`):

```sql
    -- –£–º–µ–Ω—å—à–∞–µ–º —Å—á—ë—Ç—á–∏–∫ —É tenant
    UPDATE tenants 
    SET saved_properties_count = saved_properties_count - 1
    WHERE telegram_user_id = user_id;

    RETURN TRUE;
EXCEPTION
  WHEN OTHERS THEN
    RAISE NOTICE 'Error in soft_delete_property: %', SQLERRM;
    RETURN FALSE;
END;
```

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:

### ‚úÖ –í–ê–†–ò–ê–ù–¢ 1 - –í–ï–†–ù–£–¢–¨ –°–¢–ê–†–£–Æ –õ–û–ì–ò–ö–£

**–ü–æ—á–µ–º—É:**
1. ‚úÖ –ù–µ –¥—É–±–ª–∏—Ä—É–µ—Ç –∫–æ–¥
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é `archive_property()`
3. ‚úÖ –£–º–µ–Ω—å—à–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
4. ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏
5. ‚úÖ –ö–æ—Ä–æ—á–µ –∏ –ø–æ–Ω—è—Ç–Ω–µ–µ
6. ‚úÖ –ú–µ–Ω—å—à–µ —à–∞–Ω—Å–æ–≤ –Ω–∞ –±–∞–≥–∏

**–ù–û:** –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è `archive_property()` —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ö–µ–º–æ–π!

---

## üìä –ü–†–û–í–ï–†–ö–ê archive_property():

–°–º–æ—Ç—Ä–∏–º –≤ `database/06_create_archived_properties_table.sql` (—Å—Ç—Ä–æ–∫–∏ 107-165):

```sql
CREATE OR REPLACE FUNCTION archive_property(property_id UUID, reason TEXT DEFAULT 'user_deleted', archived_by_user BIGINT DEFAULT NULL)
RETURNS BOOLEAN AS $$
DECLARE
  property_record RECORD;
  days_diff INTEGER;
BEGIN
  -- –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
  SELECT * INTO property_record
  FROM saved_properties
  WHERE id = property_id;
  
  IF NOT FOUND THEN
    RAISE EXCEPTION 'Property not found: %', property_id;
  END IF;
  
  -- –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
  days_diff := EXTRACT(DAY FROM (NOW() - property_record.created_at));
  
  -- –í—Å—Ç–∞–≤–ª—è–µ–º –≤ –∞—Ä—Ö–∏–≤ (–°–¢–ê–†–´–ï –ö–û–õ–û–ù–ö–ò - –ú–û–ñ–ï–¢ –ù–ï –†–ê–ë–û–¢–ê–¢–¨!)
  INSERT INTO archived_properties (
    id, telegram_user_id,
    latitude, longitude,
    title, description, raw_text, property_type,
    photos,
    price, currency,
    bedrooms, bathrooms, amenities,
    contact_phone, contact_name,
    source_type,
    forward_from_chat_id, forward_from_chat_title,
    forward_from_username, forward_from_message_id, forward_from_date,
    google_maps_url,
    original_created_at, original_updated_at,
    archived_at, archived_by, archive_reason,
    days_active,
    views_count, clicks_count
  ) VALUES (
    property_record.id, property_record.telegram_user_id,
    property_record.latitude, property_record.longitude,
    property_record.title, property_record.description, property_record.raw_text, property_record.property_type,
    property_record.photos,
    property_record.price, property_record.currency,
    property_record.bedrooms, property_record.bathrooms, property_record.amenities,
    property_record.contact_phone, property_record.contact_name,
    property_record.source_type,
    property_record.forward_from_chat_id, property_record.forward_from_chat_title,
    property_record.forward_from_username, property_record.forward_from_message_id, property_record.forward_date,
    property_record.google_maps_url,
    property_record.created_at, property_record.updated_at,
    NOW(), archived_by_user, reason,
    days_diff,
    0, 0
  );
  
  -- –£–¥–∞–ª—è–µ–º –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
  DELETE FROM saved_properties WHERE id = property_id;
  
  RETURN TRUE;
END;
$$ LANGUAGE plpgsql;
```

### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: 
–§—É–Ω–∫—Ü–∏—è `archive_property()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
- `raw_text` - –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ saved_properties
- `forward_from_date` –≤–º–µ—Å—Ç–æ `forward_date`
- –ù–µ –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏ –∏–∑ –Ω–æ–≤–æ–π —Å—Ö–µ–º—ã

---

## üéØ –ò–¢–û–ì–û–í–´–ô –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô:

### ‚úÖ –ß–¢–û –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨:

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `archive_property()`** –≤ `06_create_archived_properties_table.sql`
   - –£–±—Ä–∞—Ç—å `raw_text` –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤ saved_properties
   - –ò–∑–º–µ–Ω–∏—Ç—å `forward_from_date` –Ω–∞ `forward_date`
   - –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏

2. **–£–ø—Ä–æ—Å—Ç–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `soft_delete_property()`** 
   - –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É: `PERFORM archive_property()`
   - –î–æ–±–∞–≤–∏—Ç—å —É–º–µ–Ω—å—à–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ tenants
   - –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

3. **–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π SQL-—Å–∫—Ä–∏–ø—Ç** —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π

4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:**
   - –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - –°—á—ë—Ç—á–∏–∫ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è
   - –û–±—ä–µ–∫—Ç –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –∞—Ä—Ö–∏–≤

---

## üìù –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–°:

- ‚ùå **–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–ª–æ–º–∞–Ω–∞** - –Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫
- ‚ö†Ô∏è **–°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è archive_property()** - –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å—Ö–µ–º–æ–π
- ‚úÖ **PersonalMap** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω, –≤—ã–∑—ã–≤–∞–µ—Ç API
- ‚úÖ **Admin Panel** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∞—Ä—Ö–∏–≤–Ω—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏

---

**–•–æ—Ç–∏—Ç–µ —á—Ç–æ–±—ã —è —Å–æ–∑–¥–∞–ª –ü–†–ê–í–ò–õ–¨–ù–´–ô SQL-—Å–∫—Ä–∏–ø—Ç –∫–æ—Ç–æ—Ä—ã–π:**
1. –ò—Å–ø—Ä–∞–≤–∏—Ç `archive_property()` –ø–æ–¥ —Ä–µ–∞–ª—å–Ω—É—é —Å—Ö–µ–º—É
2. –£–ø—Ä–æ—Å—Ç–∏—Ç `soft_delete_property()` –¥–æ —Å—Ç–∞—Ä–æ–π –ª–æ–≥–∏–∫–∏
3. –î–æ–±–∞–≤–∏—Ç —É–º–µ–Ω—å—à–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ tenants
4. –ë—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ?
