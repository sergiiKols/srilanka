# üö® HOTFIX: –û—Ç–∫–∞—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ deleted_at

**–î–∞—Ç–∞:** 31 —è–Ω–≤–∞—Ä—è 2026, 18:50  
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø (500 –æ—à–∏–±–∫–∞ –Ω–∞ –≤—Å–µ—Ö –∫–∞—Ä—Ç–∞—Ö)

---

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ `deleted_at`, –≤—Å–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∏ –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–∞—Ä—Ç—ã –ø–µ—Ä–µ—Å—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ—à–∏–±–∫–æ–π:

```
GET /api/saved-properties - Status: 500
Error: column saved_properties.deleted_at does not exist
Code: '42703'
```

**–ü—Ä–∏—á–∏–Ω–∞:**  
–ö–æ–ª–æ–Ω–∫–∞ `deleted_at` –±—ã–ª–∞ **—É–¥–∞–ª–µ–Ω–∞** –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `saved_properties` –≤–æ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (—Ç–∞–±–ª–∏—Ü–∞ `archived_properties`), –Ω–æ –∫–æ–¥ –ø—ã—Ç–∞–ª—Å—è —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–ª–æ–Ω–∫–µ.

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –û—Ç–∫–∞—á–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ 3 —Ñ–∞–π–ª–∞—Ö:

#### 1. `src/pages/api/saved-properties.ts`
**–£–±—Ä–∞–Ω–æ:**
```typescript
.is('deleted_at', null)  // ‚ùå –ö–æ–ª–æ–Ω–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** API —Å–Ω–æ–≤–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

---

#### 2. `src/components/admin/AdminMasterMap.tsx`
**–£–±—Ä–∞–Ω–æ:**
```typescript
query = query.is('deleted_at', null);  // ‚ùå –ö–æ–ª–æ–Ω–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ê–¥–º–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –∏–∑ `saved_properties`

---

#### 3. `src/components/map/PersonalMap.tsx`
**–£–±—Ä–∞–Ω–æ:**
```typescript
const activeProperties = (data || []).filter((prop: any) => !prop.deleted_at);  // ‚ùå –ö–æ–ª–æ–Ω–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∫–∞—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üèóÔ∏è –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–±–µ–∑ deleted_at)

### –¢–∞–±–ª–∏—Ü—ã:

```
saved_properties         ‚Üí –¢–û–õ–¨–ö–û –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (–ë–ï–ó deleted_at)
archived_properties      ‚Üí –ê—Ä—Ö–∏–≤ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
admin_all_properties     ‚Üí VIEW (–æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –æ–±–µ —Ç–∞–±–ª–∏—Ü—ã)
```

### –ü–æ—á–µ–º—É deleted_at –±–æ–ª—å—à–µ –Ω–µ—Ç:

–°—Ç–∞—Ä–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (soft delete):
```sql
-- ‚ùå –°—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥
saved_properties {
  id,
  title,
  deleted_at  -- NULL = –∞–∫—Ç–∏–≤–Ω—ã–π, NOT NULL = —É–¥–∞–ª—ë–Ω–Ω—ã–π
}
```

–ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–¥–≤–µ —Ç–∞–±–ª–∏—Ü—ã):
```sql
-- ‚úÖ –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥
saved_properties {
  id,
  title
  -- –ë–ï–ó deleted_at!
}

archived_properties {
  id,
  title,
  archived_at,
  archive_reason
}
```

---

## üéØ –ò—Ç–æ–≥–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

‚úÖ **–£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤** - —Ñ—É–Ω–∫—Ü–∏—è `soft_delete_property()` –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –æ–±—ä–µ–∫—Ç –≤ `archived_properties`  
‚úÖ **–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∫–∞—Ä—Ç—ã** - –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –∏–∑ `saved_properties`  
‚úÖ **–ê–¥–º–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã, –∞—Ä—Ö–∏–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ "Show Archived"  
‚úÖ **API endpoints** - —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –æ—à–∏–±–æ–∫  

### –û—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã:

‚ùå **404 –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏** - –≤—Å–µ –µ—â—ë –µ—Å—Ç—å (–Ω–æ —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ DELETE endpoint)

---

## üîß –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã 404

–ü—Ä–æ–±–ª–µ–º–∞ 404 –æ—Å—Ç–∞–ª–∞—Å—å, –ø–æ—Ç–æ–º—É —á—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ã–ª–æ **—Ç–æ–ª—å–∫–æ –≤ DELETE endpoint**, –∏ –æ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ:

**–§–∞–π–ª:** `src/pages/api/saved-properties/[id].ts`

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
```typescript
// ‚úÖ –¢–æ–ª—å–∫–æ –û–î–ù–ê –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—ä–µ–∫—Ç–∞ (–Ω–µ –¥–≤–µ)
const { data: fullProperty, error: fullFetchError } = await supabase
  .from('saved_properties')
  .select('*')
  .eq('id', id)
  .eq('telegram_user_id', parseInt(userId))
  .single();
```

**–≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** –∏ –ù–ï —Å–≤—è–∑–∞–Ω–æ —Å `deleted_at`.

---

## üìã –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–æ—Ç–∫–∞—Ç)

1. ‚úÖ `src/pages/api/saved-properties.ts` - —É–±—Ä–∞–Ω—ã –æ–±–∞ `.is('deleted_at', null)`
2. ‚úÖ `src/components/admin/AdminMasterMap.tsx` - —É–±—Ä–∞–Ω `query.is('deleted_at', null)`
3. ‚úÖ `src/components/map/PersonalMap.tsx` - —É–±—Ä–∞–Ω —Ñ–∏–ª—å—Ç—Ä –ø–æ `deleted_at`

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –æ—Ç–∫–∞—Ç–∞

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:

1. ‚úÖ –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∫–∞—Ä—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è (–ù–ï–¢ 500 –æ—à–∏–±–∫–∏)
2. ‚úÖ –ê–¥–º–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
3. ‚úÖ "Show Archived" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
4. ‚ö†Ô∏è DELETE –∑–∞–ø—Ä–æ—Å - –Ω—É–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ

---

## üí° –í—ã–≤–æ–¥—ã

### –ü–æ—á–µ–º—É –≤–æ–∑–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞:
- –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç—å legacy-–ø–æ–¥—Ö–æ–¥ (—Ñ–∏–ª—å—Ç—Ä –ø–æ `deleted_at`) –∫ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
- –ù–µ–≤–µ—Ä–Ω–æ–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ, —á—Ç–æ –∫–æ–ª–æ–Ω–∫–∞ `deleted_at` –µ—â—ë —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥:
- `saved_properties` **–ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç** `deleted_at`
- –£–¥–∞–ª—ë–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã **—Ñ–∏–∑–∏—á–µ—Å–∫–∏** –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `archived_properties`
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ –Ω—É–∂–Ω–∞ - —Ç–∞–±–ª–∏—Ü–∞ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å –∞—Ä—Ö–∏–≤–Ω—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏:
- –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –∏—Ö —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ `archived_properties`
- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å "Show Archived" –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ

---

## ‚úÖ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ó–∞–ø—É—à–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ git**
2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ production** –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤** (404 –ø—Ä–æ–±–ª–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ—à–µ–Ω–∞)
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞** –≤ –∞–¥–º–∏–Ω–∫–µ

---

## üìä –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|------|-----------|--------|
| `src/pages/api/saved-properties/[id].ts` | –£–±—Ä–∞–Ω–∞ –¥–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| `src/pages/api/saved-properties.ts` | –û—Ç–∫–∞—á–µ–Ω —Ñ–∏–ª—å—Ç—Ä deleted_at | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| `src/components/admin/AdminMasterMap.tsx` | –û—Ç–∫–∞—á–µ–Ω —Ñ–∏–ª—å—Ç—Ä deleted_at | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| `src/components/map/PersonalMap.tsx` | –û—Ç–∫–∞—á–µ–Ω —Ñ–∏–ª—å—Ç—Ä deleted_at | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |

---

**–ò–¢–û–ì:** –í—Å–µ 500 –æ—à–∏–±–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –ü—Ä–æ–±–ª–µ–º–∞ 404 –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ—à–µ–Ω–∞ –≤ DELETE endpoint.
