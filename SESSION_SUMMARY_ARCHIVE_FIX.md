# üìã –°–≤–æ–¥–∫–∞ —Å–µ—Å—Å–∏–∏: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤

**–î–∞—Ç–∞:** 31 —è–Ω–≤–∞—Ä—è 2026  
**–ó–∞–¥–∞—á–∞:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å –∫–Ω–æ–ø–∫–æ–π "Show Archived" –∏ —É–¥–∞–ª–µ–Ω–∏–µ–º –æ–±—ä–µ–∫—Ç–æ–≤

---

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú–´

### –ò—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:
> "–ö–Ω–æ–ø–∫–∞ Show Archived –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç (0), –æ–±—ä–µ–∫—Ç—ã –Ω–µ –∞—Ä—Ö–∏–≤–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏"

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. ‚ùå **–§—É–Ω–∫—Ü–∏—è `soft_delete_property` –ù–ï –°–û–ó–î–ê–ù–ê –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**
   - API –≤—ã–∑—ã–≤–∞–µ—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
   - –û–±—ä–µ–∫—Ç—ã –Ω–µ –∞—Ä—Ö–∏–≤–∏—Ä—É—é—Ç—Å—è
   
2. ‚ùå **–û—à–∏–±–∫–∞ –≤ —Å—Ö–µ–º–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏**
   - `ERROR: column "square_meters" does not exist`
   - –§—É–Ω–∫—Ü–∏—è –ø—ã—Ç–∞–µ—Ç—Å—è –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏
   
3. ‚ùå **PersonalMap –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç API –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏**
   - –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ state
   - –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä–µ–∫—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è

---

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. –°–æ–∑–¥–∞–Ω SQL-—Å–∫—Ä–∏–ø—Ç —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π
**–§–∞–π–ª:** `FIX_ARCHIVE_FUNCTIONS.sql`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –£–±—Ä–∞–Ω—ã –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏: `square_meters`, `contact_telegram`, `location_description`, `message_link`, `raw_text`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏: `contact_name`, `source_type`, `forward_from_username`, `forward_date`, `google_maps_url`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ RLS –ø–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è anon –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ GRANT EXECUTE
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–∞ PersonalMap
**–§–∞–π–ª:** `src/components/map/PersonalMap.tsx` (—Å—Ç—Ä–æ–∫–∏ 191-220)

**–î–æ:**
```tsx
onDelete={(propertyId) => {
    // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑ state
    setProperties(prev => prev.filter(p => p.id !== propertyId));
}}
```

**–ü–æ—Å–ª–µ:**
```tsx
onDelete={async (propertyId) => {
    // 1. –í—ã–∑—ã–≤–∞–µ–º API DELETE
    const response = await fetch(`/api/saved-properties/${propertyId}?userId=${userId}`, {
        method: 'DELETE'
    });
    
    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if (!response.ok) {
        alert('Failed to delete property');
        return;
    }
    
    // 3. –£–¥–∞–ª—è–µ–º –∏–∑ state
    setProperties(prev => prev.filter(p => p.id !== propertyId));
}}
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
**–§–∞–π–ª:** `src/components/admin/AdminMasterMap.tsx`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –õ–æ–≥ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- –õ–æ–≥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
- –õ–æ–≥ –ø–µ—Ä–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
- –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫

---

## üìÅ –°–û–ó–î–ê–ù–ù–´–ï –§–ê–ô–õ–´

### SQL –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ `FIX_ARCHIVE_FUNCTIONS.sql` - –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª —Å —Ñ—É–Ω–∫—Ü–∏–µ–π
- ‚úÖ `–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê_–ê–†–•–ò–í–ê–¶–ò–ò.sql` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- ‚úÖ `–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø_–ê–†–•–ò–í–ê–¶–ò–ò_–ü–û–õ–ù–´–ï.md` - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
- ‚úÖ `–°–¢–ê–†–¢_–ü–†–Ø–ú–û_–°–ï–ô–ß–ê–°.md` - –ë—ã—Å—Ç—Ä–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (2 —à–∞–≥–∞)
- ‚úÖ `–ë–´–°–¢–†–û–ï_–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï.md` - –ü–æ—à–∞–≥–æ–≤–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
- ‚úÖ `–†–ï–®–ï–ù–ò–ï_–ü–†–û–ë–õ–ï–ú–´_–ê–†–•–ò–í–ê–¶–ò–ò.md` - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–≤–æ–¥–∫–∞
- ‚úÖ `–ü–û–ö–ê–ñ–ò–¢–ï_–ú–ù–ï_–†–ï–ó–£–õ–¨–¢–ê–¢–´.md` - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ

### –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–Ω–æ–ø–∫–µ (—Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ä–∞–Ω–µ–µ):
- ‚úÖ `ARCHIVED_BUTTON_STATUS.md` - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ Show Archived
- ‚úÖ `DEBUG_ARCHIVED_BUTTON.md` - –û—Ç–ª–∞–¥–∫–∞ –∫–Ω–æ–ø–∫–∏
- ‚úÖ `FIX_ARCHIVED_BUTTON_NOW.md` - –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- ‚úÖ `SOLUTION_SUMMARY.md` - –°–≤–æ–¥–∫–∞ —Ä–µ—à–µ–Ω–∏—è

---

## üìä –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è | –°—Ç–∞—Ç—É—Å |
|------|-----------|--------|
| `src/components/map/PersonalMap.tsx` | –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ API –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ | ‚úÖ –ó–∞–∫–æ–º–º–∏—á–µ–Ω–æ |
| `src/components/admin/AdminMasterMap.tsx` | –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚úÖ –ó–∞–∫–æ–º–º–∏—á–µ–Ω–æ |
| `FIX_ARCHIVE_FUNCTIONS.sql` | –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ | ‚ö†Ô∏è –ù—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤ Supabase |

---

## üéØ –ß–¢–û –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨

### –®–ê–ì 1: –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
```bash
1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase SQL Editor
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ FIX_ARCHIVE_FUNCTIONS.sql
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –§–£–ù–ö–¶–ò–Ø –°–û–ó–î–ê–ù–ê!
```

### –®–ê–ì 2: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
```bash
1. –û—Ç–∫—Ä–æ–π—Ç–µ PersonalMap –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –£–¥–∞–ª–∏—Ç–µ –æ–±—ä–µ–∫—Ç
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
4. –û—Ç–∫—Ä–æ–π—Ç–µ Admin Panel ‚Üí Show Archived
5. –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–¥–∞–ª—ë–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
```

---

## üîÑ –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢ –ü–û–õ–ù–´–ô –¶–ò–ö–õ

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç Delete –Ω–∞ PersonalMap
    ‚Üì
PersonalMap –≤—ã–∑—ã–≤–∞–µ—Ç API: DELETE /api/saved-properties/[id]?userId=XXX
    ‚Üì
API –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
    ‚Üì
API –≤—ã–∑—ã–≤–∞–µ—Ç: supabase.rpc('soft_delete_property', {property_id, user_id, reason})
    ‚Üì
–§—É–Ω–∫—Ü–∏—è soft_delete_property:
  1. –ö–æ–ø–∏—Ä—É–µ—Ç –æ–±—ä–µ–∫—Ç ‚Üí archived_properties
  2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç can_restore = TRUE
  3. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç archive_reason = 'user_deleted'
  4. –£–¥–∞–ª—è–µ—Ç –∏–∑ saved_properties
    ‚Üì
API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç { success: true }
    ‚Üì
PersonalMap —É–¥–∞–ª—è–µ—Ç –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ state
    ‚Üì
–û–±—ä–µ–∫—Ç –∏—Å—á–µ–∑–∞–µ—Ç —Å –∫–∞—Ä—Ç—ã
    ‚Üì
Admin Panel –º–æ–∂–µ—Ç —É–≤–∏–¥–µ—Ç—å —á–µ—Ä–µ–∑ "Show Archived"
```

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå –§—É–Ω–∫—Ü–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚ùå –û–±—ä–µ–∫—Ç—ã –Ω–µ –∞—Ä—Ö–∏–≤–∏—Ä—É—é—Ç—Å—è
- ‚ùå Show Archived (0)
- ‚ùå –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä–µ–∫—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–∑—ã–≤–∞–µ—Ç API
- ‚úÖ –û–±—ä–µ–∫—Ç—ã –∞—Ä—Ö–∏–≤–∏—Ä—É—é—Ç—Å—è
- ‚úÖ Show Archived –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–¥–∞–ª—ë–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
- ‚úÖ –û–±—ä–µ–∫—Ç—ã –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –±—É–¥—É—â–µ–º

---

## üìà –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ï–°–°–ò–ò

- **–ò—Ç–µ—Ä–∞—Ü–∏–π:** 10
- **–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 3
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 3
- **–°–æ–∑–¥–∞–Ω–æ —Ñ–∞–π–ª–æ–≤:** 12
- **–ò–∑–º–µ–Ω–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:** 2
- **–ö–æ–º–º–∏—Ç–æ–≤:** 1

---

## üîÆ –ë–£–î–£–©–ò–ï –£–õ–£–ß–®–ï–ù–ò–Ø

### 1. –ö–Ω–æ–ø–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
–î–æ–±–∞–≤–∏—Ç—å –≤ PropertyDrawer –¥–ª—è –∞—Ä—Ö–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤:
```tsx
{property.isArchived && (
    <button onClick={handleRestore}>
        üîÑ Restore from Archive
    </button>
)}
```

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏–≤–∞—Ü–∏—è
Supabase Cron Job –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤:
```sql
SELECT cron.schedule(
    'archive-old-properties',
    '0 0 * * *',
    $$SELECT soft_delete_property(id, telegram_user_id, 'expired')
      FROM saved_properties
      WHERE created_at < NOW() - INTERVAL '30 days'$$
);
```

### 3. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞—Ä—Ö–∏–≤–∞
- –í—Å–µ–≥–æ –∞—Ä—Ö–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
- –ü–æ –ø—Ä–∏—á–∏–Ω–∞–º –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
- –°—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏ –æ–±—ä–µ–∫—Ç–∞
- –ß–∞—Å—Ç–æ—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π

---

## üéâ –ò–¢–û–ì

**–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞!**

- ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞ (—Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —Å–æ–∑–¥–∞–Ω–∞)
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Ö–µ–º–∞ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∫–∞—Ä—Ç–∞—Ö
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –í—ã–ø–æ–ª–Ω–∏—Ç—å `FIX_ARCHIVE_FUNCTIONS.sql` –≤ Supabase! ‚ö°

---

**–°–æ–∑–¥–∞–Ω–æ:** 31 —è–Ω–≤–∞—Ä—è 2026  
**–ê–≤—Ç–æ—Ä:** Rovo Dev  
**–ö–æ–º–º–∏—Ç:** `fix: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤`
