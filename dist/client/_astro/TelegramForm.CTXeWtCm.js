import{j as s}from"./jsx-runtime.D_zvdyIk.js";import{r as l}from"./index.JXKNaeUN.js";function E({formId:u}){const[i,f]=l.useState(null),[x,h]=l.useState({}),[b,p]=l.useState({}),[N,y]=l.useState(!0),[d,g]=l.useState(!1),[a,w]=l.useState(null);l.useEffect(()=>{if(typeof window<"u"&&window.Telegram?.WebApp){const e=window.Telegram.WebApp;w(e),e.ready(),e.expand(),document.body.style.backgroundColor=e.backgroundColor,e.BackButton.show(),e.BackButton.onClick(()=>{e.close()}),console.log("Telegram Web App initialized:",e.initDataUnsafe)}else console.warn("Telegram Web App SDK not found")},[]),l.useEffect(()=>{(async()=>{try{const r=await(await fetch(`/api/admin/forms/${u}`)).json();if(r.success&&r.data){f(r.data);const c={};r.data.fields.forEach(o=>{c[o.id]=o.type==="checkbox"?!1:""}),h(c)}else a?.showAlert("Не удалось загрузить форму")}catch(t){console.error("Failed to load form:",t),a?.showAlert("Ошибка загрузки формы")}finally{y(!1)}})()},[u,a]);const k=(e,t)=>{if(e.required&&(!t||t===""))return"Это поле обязательно";if(e.type==="email"&&t&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t))return"Неверный формат email";if(e.type==="tel"&&t&&!/^[\d\s\-\+\(\)]+$/.test(t))return"Неверный формат телефона";if(e.validation){const{min:r,max:c,pattern:o,message:n}=e.validation;if(r!==void 0&&String(t).length<r)return n||`Минимум ${r} символов`;if(c!==void 0&&String(t).length>c)return n||`Максимум ${c} символов`;if(o&&t&&!new RegExp(o).test(String(t)))return n||"Неверный формат"}return null},m=(e,t)=>{h(r=>({...r,[e.id]:t})),b[e.id]&&p(r=>{const c={...r};return delete c[e.id],c}),a?.HapticFeedback.selectionChanged()},v=()=>{if(!i)return!1;const e={};return i.fields.forEach(t=>{const r=k(t,x[t.id]);r&&(e[t.id]=r)}),p(e),Object.keys(e).length===0},S=async e=>{if(e.preventDefault(),!(!a||!i)){if(!v()){a.HapticFeedback.notificationOccurred("error"),a.showAlert("Пожалуйста, исправьте ошибки в форме");return}g(!0),a.MainButton.showProgress();try{const t=a.initDataUnsafe.user;if(!t){a.showAlert("Не удалось получить данные пользователя");return}const r={form_id:u,user_id:String(t.id),first_name:t.first_name,last_name:t.last_name,username:t.username,data:x,initData:a.initData},o=await(await fetch("/api/telegram-form",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})).json();o.success?(a.HapticFeedback.notificationOccurred("success"),a.sendData(JSON.stringify({status:"ok",submission_id:o.submission_id})),a.showAlert("Заявка успешно отправлена!",()=>{a.close()})):(a.HapticFeedback.notificationOccurred("error"),a.showAlert(o.error||"Не удалось отправить заявку"))}catch(t){console.error("Submit error:",t),a.HapticFeedback.notificationOccurred("error"),a.showAlert("Произошла ошибка при отправке")}finally{g(!1),a.MainButton.hideProgress()}}},F=e=>{const t=x[e.id]||"",r=b[e.id],c=!!r,o=`
      w-full px-4 py-3 rounded-lg border
      ${c?"border-red-500":"border-gray-300"}
      focus:outline-none focus:ring-2
      ${c?"focus:ring-red-500":"focus:ring-blue-500"}
      transition-colors
      text-base
    `;switch(e.type){case"textarea":return s.jsxs("div",{className:"mb-4",children:[s.jsxs("label",{className:"block text-sm font-medium mb-2",children:[e.label,e.required&&s.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),s.jsx("textarea",{value:t,onChange:n=>m(e,n.target.value),placeholder:e.placeholder,rows:4,className:o,disabled:d}),c&&s.jsx("p",{className:"text-red-500 text-sm mt-1",children:r})]},e.id);case"select":return s.jsxs("div",{className:"mb-4",children:[s.jsxs("label",{className:"block text-sm font-medium mb-2",children:[e.label,e.required&&s.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),s.jsxs("select",{value:t,onChange:n=>m(e,n.target.value),className:o,disabled:d,children:[s.jsx("option",{value:"",children:"Выберите..."}),e.options?.map(n=>s.jsx("option",{value:n,children:n},n))]}),c&&s.jsx("p",{className:"text-red-500 text-sm mt-1",children:r})]},e.id);case"checkbox":return s.jsxs("div",{className:"mb-4",children:[s.jsxs("label",{className:"flex items-center cursor-pointer",children:[s.jsx("input",{type:"checkbox",checked:t===!0,onChange:n=>m(e,n.target.checked),className:"w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-2 focus:ring-blue-500",disabled:d}),s.jsxs("span",{className:"ml-3 text-sm",children:[e.label,e.required&&s.jsx("span",{className:"text-red-500 ml-1",children:"*"})]})]}),c&&s.jsx("p",{className:"text-red-500 text-sm mt-1",children:r})]},e.id);case"radio":return s.jsxs("div",{className:"mb-4",children:[s.jsxs("label",{className:"block text-sm font-medium mb-2",children:[e.label,e.required&&s.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),s.jsx("div",{className:"space-y-2",children:e.options?.map(n=>s.jsxs("label",{className:"flex items-center cursor-pointer",children:[s.jsx("input",{type:"radio",name:e.id,value:n,checked:t===n,onChange:j=>m(e,j.target.value),className:"w-4 h-4 text-blue-600 focus:ring-2 focus:ring-blue-500",disabled:d}),s.jsx("span",{className:"ml-3 text-sm",children:n})]},n))}),c&&s.jsx("p",{className:"text-red-500 text-sm mt-1",children:r})]},e.id);default:return s.jsxs("div",{className:"mb-4",children:[s.jsxs("label",{className:"block text-sm font-medium mb-2",children:[e.label,e.required&&s.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),s.jsx("input",{type:e.type,value:t,onChange:n=>m(e,n.target.value),placeholder:e.placeholder,className:o,disabled:d}),c&&s.jsx("p",{className:"text-red-500 text-sm mt-1",children:r})]},e.id)}};return N?s.jsx("div",{className:"flex items-center justify-center min-h-screen",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"Загрузка формы..."})]})}):i?s.jsx("div",{className:"min-h-screen p-4 pb-20",children:s.jsxs("div",{className:"max-w-lg mx-auto",children:[s.jsx("h1",{className:"text-2xl font-bold mb-2",children:i.title}),i.description&&s.jsx("p",{className:"text-gray-600 mb-6",children:i.description}),s.jsxs("form",{onSubmit:S,children:[i.fields.map(e=>F(e)),s.jsx("button",{type:"submit",disabled:d,className:"w-full py-4 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors text-base",children:d?"Отправка...":i.submit_text})]})]})}):s.jsx("div",{className:"flex items-center justify-center min-h-screen p-4",children:s.jsx("div",{className:"text-center",children:s.jsx("p",{className:"text-red-600 text-lg",children:"Форма не найдена"})})})}export{E as default};
