# üîí –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–• –ö–ê–†–¢

**–î–∞—Ç–∞:** 2026-01-29  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å –ª–∏—á–Ω—ã–µ –∫–∞—Ä—Ç—ã –æ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞?

---

## üö® –ü–†–û–ë–õ–ï–ú–ê

### –¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ (–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π):
```
URL: /map/{telegram_user_id}
–ü—Ä–∏–º–µ—Ä: /map/1000089271

–†–ò–°–ö:
–ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–±–∏—Ä–∞—Ç—å ID:
/map/1000089270
/map/1000089271
/map/1000089272
...
/map/1000099999

–ò –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —á—É–∂–∏–º –∫–∞—Ä—Ç–∞–º!
```

---

## üí° –†–ï–®–ï–ù–ò–Ø (–æ—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ –∫ —Å–ª–æ–∂–Ω–æ–º—É)

### –†–ï–®–ï–ù–ò–ï 1: –°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é!) ‚≠ê‚≠ê‚≠ê

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –∫ URL

```
URL: /map/{telegram_user_id}/{secret_token}
–ü—Ä–∏–º–µ—Ä: /map/1000089271/a7f3b9e2c1d4...

–¢–æ–∫–µ–Ω:
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞—Ä—Ç—ã
- –•—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–≥–∞–¥–∞—Ç—å (256 –±–∏—Ç = 10^77 –∫–æ–º–±–∏–Ω–∞—Ü–∏–π)
- –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π (–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)
```

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î:

```sql
CREATE TABLE tenants (
  id UUID PRIMARY KEY,
  telegram_user_id BIGINT UNIQUE NOT NULL,
  map_secret_token TEXT UNIQUE NOT NULL,  ‚Üê –ù–û–í–û–ï –ü–û–õ–ï
  personal_map_url TEXT UNIQUE,
  created_at TIMESTAMPTZ
);

-- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏:
INSERT INTO tenants VALUES (
  uuid_generate_v4(),
  1000089271,
  encode(gen_random_bytes(32), 'hex'),  -- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
  '/map/1000089271/a7f3b9e2c1d4...',
  NOW()
);
```

#### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–ú–æ—è –∫–∞—Ä—Ç–∞"
   ‚Üì
2. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–π URL —Å —Ç–æ–∫–µ–Ω–æ–º:
   https://site.com/map/1000089271/a7f3b9e2c1d4...
   ‚Üì
3. –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
   SELECT * FROM tenants 
   WHERE telegram_user_id = 1000089271 
   AND map_secret_token = 'a7f3b9e2...'
   ‚Üì
4. –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –ù–ï —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Üí 403 Forbidden
   –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç—É
```

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
‚úÖ –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è  
‚úÖ –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞ (–º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∑–∞–∫–ª–∞–¥–∫–∏)  
‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ç–æ–∫–µ–Ω  
‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç offline (—Å—Å—ã–ª–∫–∞ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)

#### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
‚ùå –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ —É—Ç–µ–∫–ª–∞ - –¥–æ—Å—Ç—É–ø –Ω–∞–≤—Å–µ–≥–¥–∞  
‚ùå –ù–µ–ª—å–∑—è –æ—Ç–æ–∑–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –±–µ–∑ —Å–º–µ–Ω—ã —Ç–æ–∫–µ–Ω–∞

---

### –†–ï–®–ï–ù–ò–ï 2: –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (–æ—á–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ) ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:** –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏

```
URL: /map/{telegram_user_id}/{temp_token}
–ü—Ä–∏–º–µ—Ä: /map/1000089271/temp_xyz123...

–¢–æ–∫–µ–Ω:
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∑–∞–Ω–æ–≤–æ
- –î–µ–π—Å—Ç–≤—É–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è (15 –º–∏–Ω—É—Ç)
- –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è - –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
- –•—Ä–∞–Ω–∏—Ç—Å—è –≤ Redis –∏–ª–∏ —Ç–∞–±–ª–∏—Ü–µ sessions
```

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î:

```sql
-- –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
CREATE TABLE tenants (
  id UUID PRIMARY KEY,
  telegram_user_id BIGINT UNIQUE NOT NULL,
  personal_map_url TEXT,
  created_at TIMESTAMPTZ
);

-- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
CREATE TABLE map_sessions (
  id UUID PRIMARY KEY,
  telegram_user_id BIGINT REFERENCES tenants(telegram_user_id),
  access_token TEXT UNIQUE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL,
  is_active BOOLEAN DEFAULT true
);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX idx_map_sessions_token ON map_sessions(access_token);
CREATE INDEX idx_map_sessions_expires ON map_sessions(expires_at);

-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç—ë–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤
CREATE OR REPLACE FUNCTION cleanup_expired_sessions()
RETURNS void AS $$
BEGIN
  DELETE FROM map_sessions WHERE expires_at < NOW();
END;
$$ LANGUAGE plpgsql;
```

#### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ú–æ—è –∫–∞—Ä—Ç–∞"
   ‚Üì
2. –ë–æ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω:
   temp_token = generate_token()
   expires_at = NOW() + 15 minutes
   ‚Üì
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î:
   INSERT INTO map_sessions (telegram_user_id, access_token, expires_at)
   VALUES (1000089271, 'temp_xyz123...', NOW() + INTERVAL '15 minutes')
   ‚Üì
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É:
   https://site.com/map/1000089271/temp_xyz123...
   ‚Üì
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Å—ã–ª–∫—É (–≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç)
   ‚Üì
6. –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
   SELECT * FROM map_sessions
   WHERE access_token = 'temp_xyz123...'
   AND expires_at > NOW()
   AND is_active = true
   ‚Üì
7. –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç—É
   –ï—Å–ª–∏ –∏—Å—Ç—ë–∫ ‚Üí "–°—Å—ã–ª–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞, –∑–∞–ø—Ä–æ—Å–∏ –Ω–æ–≤—É—é –≤ –±–æ—Ç–µ"
```

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
‚úÖ –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å  
‚úÖ –¢–æ–∫–µ–Ω —É—Å—Ç–∞—Ä–µ–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏  
‚úÖ –ú–æ–∂–Ω–æ –æ—Ç–æ–∑–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø (is_active = false)  
‚úÖ –ò—Å—Ç–æ—Ä–∏—è –¥–æ—Å—Ç—É–ø–∞ (–∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏)  
‚úÖ –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ —É—Ç–µ–∫–ª–∞ - —á–µ—Ä–µ–∑ 15 –º–∏–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞

#### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
‚ùå –ù—É–∂–Ω–æ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É  
‚ùå –ù–µ–ª—å–∑—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∑–∞–∫–ª–∞–¥–∫–∏  
‚ùå –¢—Ä–µ–±—É–µ—Ç –ë–î/Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–π

---

### –†–ï–®–ï–ù–ò–ï 3: JWT —Ç–æ–∫–µ–Ω—ã (–∫–æ–º–ø—Ä–æ–º–∏—Å—Å) ‚≠ê‚≠ê‚≠ê‚≠ê

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JSON Web Token

```
URL: /map?token={JWT}
–ü—Ä–∏–º–µ—Ä: /map?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

JWT —Å–æ–¥–µ—Ä–∂–∏—Ç:
{
  "user_id": 1000089271,
  "exp": 1738150000,  // –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è
  "iat": 1738148000   // –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
}

–ü–æ–¥–ø–∏—Å–∞–Ω —Å–µ–∫—Ä–µ—Ç–Ω—ã–º –∫–ª—é—á–æ–º —Å–µ—Ä–≤–µ—Ä–∞
```

#### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ú–æ—è –∫–∞—Ä—Ç–∞"
   ‚Üì
2. –ë–æ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç JWT —É —Å–µ—Ä–≤–µ—Ä–∞:
   POST /api/generate-map-token
   Body: { telegram_user_id: 1000089271 }
   ‚Üì
3. –°–µ—Ä–≤–µ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JWT:
   const token = jwt.sign(
     { user_id: 1000089271, exp: Date.now() + 15min },
     SECRET_KEY
   )
   ‚Üì
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –±–æ—Ç—É
   ‚Üì
5. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
   https://site.com/map?token=eyJhbGci...
   ‚Üì
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç
   ‚Üì
7. –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT:
   jwt.verify(token, SECRET_KEY)
   ‚Üì
8. –ò–∑–≤–ª–µ–∫–∞–µ—Ç user_id –∏–∑ —Ç–æ–∫–µ–Ω–∞
   ‚Üì
9. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (exp)
   ‚Üì
10. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç—É
```

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
‚úÖ –ù–µ –Ω—É–∂–Ω–∞ –ë–î –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ (stateless)  
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å—Ç–µ—á–µ–Ω–∏–µ (exp –≤ —Ç–æ–∫–µ–Ω–µ)  
‚úÖ –ù–µ–ª—å–∑—è –ø–æ–¥–¥–µ–ª–∞—Ç—å (–ø–æ–¥–ø–∏—Å—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è)  
‚úÖ –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è

#### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
‚ùå –ù–µ–ª—å–∑—è –æ—Ç–æ–∑–≤–∞—Ç—å –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è (stateless)  
‚ùå –î–ª–∏–Ω–Ω—ã–π URL (JWT ~150-200 —Å–∏–º–≤–æ–ª–æ–≤)  
‚ùå –¢—Ä–µ–±—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JWT

---

### –†–ï–®–ï–ù–ò–ï 4: One-Time Links (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å) ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:** –°—Å—ã–ª–∫–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑

```
URL: /map/{telegram_user_id}/{one_time_token}
–ü—Ä–∏–º–µ—Ä: /map/1000089271/otp_abc123...

–¢–æ–∫–µ–Ω:
- –î–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑
- –ü–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è - —É–¥–∞–ª—è–µ—Ç—Å—è
- –î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ - –Ω–æ–≤–∞—è —Å—Å—ã–ª–∫–∞
```

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î:

```sql
CREATE TABLE one_time_tokens (
  id UUID PRIMARY KEY,
  telegram_user_id BIGINT NOT NULL,
  token TEXT UNIQUE NOT NULL,
  used BOOLEAN DEFAULT false,
  used_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL
);
```

#### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

```
1. –ù–∞–∂–∞–ª "–ú–æ—è –∫–∞—Ä—Ç–∞"
   ‚Üì
2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è one-time —Ç–æ–∫–µ–Ω
   ‚Üì
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è: used = false
   ‚Üì
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞
   ‚Üì
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç (–ø–µ—Ä–≤—ã–π —Ä–∞–∑)
   ‚Üì
6. –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
   - —Ç–æ–∫–µ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?
   - used = false?
   - –Ω–µ –∏—Å—Ç—ë–∫?
   ‚Üì
7. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç—É
   ‚Üì
8. –ü–æ–º–µ—á–∞–µ—Ç: used = true, used_at = NOW()
   ‚Üì
9. –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ ‚Üí "–°—Å—ã–ª–∫–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞"
```

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å  
‚úÖ –°—Å—ã–ª–∫–∞ —Å–≥–æ—Ä–∞–µ—Ç –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è  
‚úÖ –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –¥—Ä—É–≥–∏–º

#### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
‚ùå –û—á–µ–Ω—å –Ω–µ—É–¥–æ–±–Ω–æ (–Ω—É–∂–Ω–∞ –Ω–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ –∫–∞–∂–¥—ã–π —Ä–∞–∑)  
‚ùå –°–ª—É—á–∞–π–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –≤–∫–ª–∞–¥–∫–∏ - –ø–æ—Ç–µ—Ä—è –¥–æ—Å—Ç—É–ø–∞  
‚ùå –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —á–∞—Å—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

## üìä –°–†–ê–í–ù–ï–ù–ò–ï –†–ï–®–ï–ù–ò–ô

| –†–µ—à–µ–Ω–∏–µ | –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | –£–¥–æ–±—Å—Ç–≤–æ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|---------|--------------|----------|-----------|--------------|
| 1. –°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê | **MVP** |
| 2. –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê | **Production** |
| 3. JWT | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê | –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ #2 |
| 4. One-Time | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê | ‚≠ê‚≠ê‚≠ê | –î–ª—è –±–∞–Ω–∫–æ–≤ |

---

## üéØ –ú–û–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

### –î–õ–Ø MVP: –†–ï–®–ï–ù–ò–ï 1 (–°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω) ‚≠ê

**–ü–æ—á–µ–º—É:**
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (1 –ø–æ–ª–µ –≤ –ë–î)
- ‚úÖ –£–¥–æ–±–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞)
- ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–≥–∞–¥–∞—Ç—å)
- ‚úÖ –ë—ã—Å—Ç—Ä–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å

**–†–∏—Å–∫:**
- ‚ùå –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ —É—Ç–µ–∫–ª–∞ - –¥–æ—Å—Ç—É–ø –Ω–∞–≤—Å–µ–≥–¥–∞
- **–ù–û:** –î–ª—è –ª–∏—á–Ω–æ–π –∑–∞–ø–∏—Å–Ω–æ–π –∫–Ω–∏–∂–∫–∏ —ç—Ç–æ –ø—Ä–∏–µ–º–ª–µ–º–æ

**–ö–æ–¥:**

```sql
-- –ë–î
CREATE TABLE tenants (
  telegram_user_id BIGINT PRIMARY KEY,
  map_secret_token TEXT UNIQUE NOT NULL DEFAULT encode(gen_random_bytes(32), 'hex'),
  personal_map_url TEXT
);

-- URL
/map/{telegram_user_id}/{map_secret_token}
```

```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
export async function GET({ params }) {
  const { telegram_user_id, token } = params;
  
  const tenant = await supabase
    .from('tenants')
    .select('*')
    .eq('telegram_user_id', telegram_user_id)
    .eq('map_secret_token', token)
    .single();
  
  if (!tenant) {
    return new Response('Access Denied', { status: 403 });
  }
  
  // –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç—É
}
```

---

### –î–õ–Ø PRODUCTION: –†–ï–®–ï–ù–ò–ï 2 (–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã) ‚≠ê‚≠ê‚≠ê

**–ö–æ–≥–¥–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å:**
- –ö–æ–≥–¥–∞ MVP —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ö–æ–≥–¥–∞ –ø–æ—è–≤–∏–ª–∏—Å—å —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –ø–æ–≤—ã—à–µ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–ü–µ—Ä–µ—Ö–æ–¥:**
```sql
-- –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å–µ—Å—Å–∏–π
CREATE TABLE map_sessions (
  telegram_user_id BIGINT,
  access_token TEXT UNIQUE,
  expires_at TIMESTAMPTZ
);

-- –û—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
-- –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
-- –°—Ç–∞—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
```

---

## üîß –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê

### 1. Rate Limiting

```sql
-- –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ–¥–Ω–æ–≥–æ IP
CREATE TABLE access_logs (
  ip_address INET,
  telegram_user_id BIGINT,
  accessed_at TIMESTAMPTZ,
  success BOOLEAN
);

-- –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –±–æ–ª–µ–µ 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É —Å –æ–¥–Ω–æ–≥–æ IP
SELECT COUNT(*) FROM access_logs
WHERE ip_address = '1.2.3.4'
AND accessed_at > NOW() - INTERVAL '1 minute';

-- –ï—Å–ª–∏ > 10 ‚Üí –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 5 –º–∏–Ω—É—Ç
```

### 2. IP Whitelist (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```sql
CREATE TABLE tenant_ip_whitelist (
  telegram_user_id BIGINT,
  allowed_ip INET
);

-- –†–∞–∑—Ä–µ—à–∞—Ç—å –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö IP
```

### 3. Browser Fingerprint

```javascript
// –°–æ—Ö—Ä–∞–Ω—è—Ç—å fingerprint –±—Ä–∞—É–∑–µ—Ä–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –¥–æ—Å—Ç—É–ø–µ
const fingerprint = await getFingerprint(); // User-Agent + Screen + etc

// –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å fingerprint
if (storedFingerprint !== currentFingerprint) {
  // –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
  sendAlertToUser();
}
```

### 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–æ—Å—Ç—É–ø–µ

```javascript
// –ü—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–∞—Ä—Ç—ã - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
bot.sendMessage(telegram_user_id,
  'üîî –¢–≤–æ—è –∫–∞—Ä—Ç–∞ –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞\n' +
  'üìÖ ' + new Date() + '\n' +
  'üìç IP: ' + ip_address + '\n\n' +
  '–≠—Ç–æ –±—ã–ª —Ç—ã? –ï—Å–ª–∏ –Ω–µ—Ç - –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.',
  {
    reply_markup: {
      inline_keyboard: [[
        { text: 'üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø', callback_data: 'revoke_access' }
      ]]
    }
  }
);
```

---

## üíº –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –î–õ–Ø MVP

### –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤–µ—Ä—Å–∏—è:

```sql
-- 1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ —Ç–æ–∫–µ–Ω–∞
ALTER TABLE tenants 
ADD COLUMN map_secret_token TEXT UNIQUE;

-- 2. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
UPDATE tenants 
SET map_secret_token = encode(gen_random_bytes(32), 'hex')
WHERE map_secret_token IS NULL;

-- 3. –û–±–Ω–æ–≤–∏—Ç—å URL
UPDATE tenants
SET personal_map_url = '/map/' || telegram_user_id || '/' || map_secret_token;
```

```javascript
// –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–π URL —Å —Ç–æ–∫–µ–Ω–æ–º
const tenant = await getTenant(telegram_user_id);
const mapUrl = `https://site.com/map/${telegram_user_id}/${tenant.map_secret_token}`;

bot.sendMessage(chatId, '–¢–≤–æ—è –∫–∞—Ä—Ç–∞:', {
  reply_markup: {
    inline_keyboard: [[
      { text: 'üó∫Ô∏è –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É', url: mapUrl }
    ]]
  }
});
```

```astro
---
// src/pages/map/[telegram_user_id]/[token].astro

export const prerender = false;

const { telegram_user_id, token } = Astro.params;

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
const { data: tenant } = await supabase
  .from('tenants')
  .select('*')
  .eq('telegram_user_id', telegram_user_id)
  .eq('map_secret_token', token)
  .single();

if (!tenant) {
  return Astro.redirect('/access-denied');
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä–µ–∫—Ç—ã
const { data: properties } = await supabase
  .from('saved_properties')
  .select('*')
  .eq('telegram_user_id', telegram_user_id);
---

<html>
  <body>
    <h1>–¢–≤–æ—è –∫–∞—Ä—Ç–∞</h1>
    <div id="map"></div>
    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ -->
  </body>
</html>
```

---

## ‚úÖ –ò–¢–û–ì–û

### –†–µ–∫–æ–º–µ–Ω–¥—É—é –¥–ª—è —Å—Ç–∞—Ä—Ç–∞:
**–†–ï–®–ï–ù–ò–ï 1: –°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω**

- URL: `/map/{telegram_user_id}/{secret_token}`
- –¢–æ–∫–µ–Ω: 256 –±–∏—Ç, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–≥–∞–¥–∞—Ç—å
- –•—Ä–∞–Ω–∏—Ç—Å—è: 1 –ø–æ–ª–µ –≤ —Ç–∞–±–ª–∏—Ü–µ `tenants`
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è: –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π

### –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:
**–†–ï–®–ï–ù–ò–ï 2: –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (15 –º–∏–Ω—É—Ç)**

- –ö–æ–≥–¥–∞ MVP –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—Å—è
- –ö–æ–≥–¥–∞ –±—É–¥—É—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É `map_sessions`
- –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏

---

**–ö–∞–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ –≤—ã–±–∏—Ä–∞–µ–º –¥–ª—è —Å—Ç–∞—Ä—Ç–∞?** üîí

**A)** –°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω (–ø—Ä–æ—Å—Ç–æ–π MVP)  
**B)** –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π)  
**C)** JWT (–∫–æ–º–ø—Ä–æ–º–∏—Å—Å)  
**D)** –î—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç?
