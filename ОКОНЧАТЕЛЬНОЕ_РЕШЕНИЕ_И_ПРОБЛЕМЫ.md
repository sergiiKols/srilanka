# üéØ –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–û–ï –†–ï–ó–Æ–ú–ï: –ü—Ä–æ–±–ª–µ–º—ã –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏

## ‚ùå –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:

### 1. –§—É–Ω–∫—Ü–∏—è `soft_delete_property` –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ –≤ –±–∞–∑–µ
- **–†–µ—à–µ–Ω–æ:** –ü—ã—Ç–∞–ª–∏—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑

### 2. –ö–æ–ª–æ–Ω–∫–∞ `forward_from_date` vs `forward_date`
- **–†–µ—à–µ–Ω–æ:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ `forward_date`

### 3. PersonalMap –Ω–µ –≤—ã–∑—ã–≤–∞–ª API –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
- **–†–µ—à–µ–Ω–æ:** –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `fetch('/api/saved-properties/[id]', {method: 'DELETE'})`

### 4. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö `amenities`: jsonb vs text[]
- **–ù–∞–π–¥–µ–Ω–æ:** `saved_properties.amenities` = jsonb, `archived_properties.amenities` = text[]
- **–†–µ—à–µ–Ω–∏–µ:** –ù—É–∂–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è `ARRAY(SELECT jsonb_array_elements_text(...))`

### 5. RLS –Ω–∞ `saved_properties`
- **–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:** –û—Ç–∫–ª—é—á–µ–Ω, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 6. **–ì–õ–ê–í–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:** Supabase SQL Editor —Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π
- –°–ª–æ–≤–æ "Record" –≤ DECLARE –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –∫–æ–¥–∏—Ä–æ–≤–∫–∏
- Supabase –Ω–µ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å SQL —Å –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏

---

## ‚úÖ –ß–¢–û –†–ê–ë–û–¢–ê–ï–¢:

1. ‚úÖ –†—É—á–Ω–æ–π INSERT –≤ `archived_properties` —Ä–∞–±–æ—Ç–∞–µ—Ç
2. ‚úÖ –†—É—á–Ω–æ–π DELETE –∏–∑ `saved_properties` —Ä–∞–±–æ—Ç–∞–µ—Ç  
3. ‚úÖ PersonalMap –≤—ã–∑—ã–≤–∞–µ—Ç API –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. ‚úÖ Admin Panel –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (1 —Ç–µ—Å—Ç–æ–≤—ã–π –µ—Å—Ç—å)

---

## üîß –†–ï–®–ï–ù–ò–ï:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é —á–µ—Ä–µ–∑ psql/pgAdmin (–Ω–µ —á–µ—Ä–µ–∑ Supabase UI)

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –±–µ–∑ UI.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –£–ø—Ä–æ—Å—Ç–∏—Ç—å –¥–æ API-—É—Ä–æ–≤–Ω—è

–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ª–æ–≥–∏–∫—É –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –≤ TypeScript API endpoint –≤–º–µ—Å—Ç–æ SQL —Ñ—É–Ω–∫—Ü–∏–∏.

**–§–∞–π–ª:** `src/pages/api/saved-properties/[id].ts`

–ò–∑–º–µ–Ω–∏—Ç—å DELETE handler:

```typescript
if (request.method === 'DELETE') {
  const { userId } = url.searchParams;
  
  // 1. Get property
  const { data: property } = await supabase
    .from('saved_properties')
    .select('*')
    .eq('id', id)
    .eq('telegram_user_id', userId)
    .single();
    
  if (!property) {
    return new Response(JSON.stringify({ error: 'Not found' }), { status: 404 });
  }
  
  // 2. Convert amenities jsonb to text[]
  const amenitiesArray = property.amenities 
    ? Array.isArray(property.amenities) 
      ? property.amenities 
      : [] 
    : null;
  
  // 3. Insert into archive
  await supabase.from('archived_properties').insert({
    ...property,
    amenities: amenitiesArray,
    archived_at: new Date().toISOString(),
    archived_by: userId,
    archive_reason: 'user_deleted',
    can_restore: true,
    days_active: Math.floor((Date.now() - new Date(property.created_at).getTime()) / (1000 * 60 * 60 * 24)),
    original_created_at: property.created_at,
    original_updated_at: property.updated_at,
    views_count: 0,
    clicks_count: 0
  });
  
  // 4. Delete from saved
  await supabase
    .from('saved_properties')
    .delete()
    .eq('id', id)
    .eq('telegram_user_id', userId);
    
  // 5. Update counter
  await supabase.rpc('decrement_user_properties_count', { user_id: userId });
  
  return new Response(JSON.stringify({ success: true }), { status: 200 });
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Supabase Dashboard SQL Editor –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º

–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ —è–∑—ã–∫ Supabase –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.

---

## üìä –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï:

- `saved_properties`: 3 —Ç–µ—Å—Ç–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–∞ (user 999999999)
- `archived_properties`: 1 –æ–±—ä–µ–∫—Ç (–≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞–Ω–Ω—ã–π)
- `soft_delete_property`: –ù–ï –†–ê–ë–û–¢–ê–ï–¢ –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å–æ–∑–¥–∞–Ω–∏—è
- PersonalMap: ‚úÖ –í—ã–∑—ã–≤–∞–µ—Ç API
- Admin Panel: ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏–≤

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –í–∞—Ä–∏–∞–Ω—Ç 2** - –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ª–æ–≥–∏–∫—É –≤ TypeScript API.

**–ü–æ—á–µ–º—É:**
- –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π SQL
- –õ–µ–≥—á–µ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å
- –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Ç–∏–ø–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
- –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç SQL —Ñ—É–Ω–∫—Ü–∏–π

---

## üìù –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:

1. –û—Ç–∫—Ä—ã—Ç—å `src/pages/api/saved-properties/[id].ts`
2. –ó–∞–º–µ–Ω–∏—Ç—å DELETE handler –Ω–∞ –∫–æ–¥ –∏–∑ –í–∞—Ä–∏–∞–Ω—Ç–∞ 2
3. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `decrement_user_properties_count` –≤ Supabase:
   ```sql
   CREATE FUNCTION decrement_user_properties_count(user_id BIGINT)
   RETURNS VOID AS $$
   BEGIN
     UPDATE tenants 
     SET saved_properties_count = GREATEST(saved_properties_count - 1, 0)
     WHERE telegram_user_id = user_id;
   END;
   $$ LANGUAGE plpgsql;
   ```
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PersonalMap
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Admin Panel –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏–≤

---

**–í—Ä–µ–º—è –Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –í–∞—Ä–∏–∞–Ω—Ç–∞ 2:** 15 –º–∏–Ω—É—Ç  
**–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (100%)

---

–•–æ—Ç–∏—Ç–µ —á—Ç–æ–±—ã —è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –í–∞—Ä–∏–∞–Ω—Ç 2 –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?
