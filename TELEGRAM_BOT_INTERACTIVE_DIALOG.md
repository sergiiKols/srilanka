# 💬 ИНТЕРАКТИВНЫЙ ДИАЛОГ С БОТОМ - Пошаговый процесс

**Дата:** 2026-01-29  
**Система:** Пошаговое добавление объекта

---

## 🎯 ДВА РЕЖИМА РАБОТЫ

### **РЕЖИМ 1: БЫСТРЫЙ (Forward) - 1 шаг** ⚡ РЕКОМЕНДУЕМЫЙ

```
👤 Клиент: [Forward сообщение с фото + текст + геолокация]

🤖 Бот (через 2 сек):
    ✅ Объект сохранён! (всего: 5)
    
    Готово! Всё в одном сообщении ✅
```

**Преимущество:** Быстро, всё в одном действии!

---

### **РЕЖИМ 2: ПОШАГОВЫЙ (Interactive) - 3-4 шага** 📝 ДЛЯ ДЕТАЛЬНОГО ВВОДА

Когда клиент отправляет данные **отдельными сообщениями**

---

## 📱 ПОШАГОВЫЙ ДИАЛОГ (РЕЖИМ 2)

### **ВАРИАНТ A: Фото → Геолокация → Описание**

```
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 1: Клиент отправляет ФОТО                              │
└─────────────────────────────────────────────────────────────┘

👤 Клиент: 📸📸📸 [3 фотографии без текста]

🤖 Бот (моментально):

┌─────────────────────────────────────────┐
│ 📸 Фото получены! (3 шт.)               │
│                                         │
│ ✅ Сохраню как новый объект             │
│                                         │
│ 📍 Теперь отправь:                      │
│ • Геолокацию объекта                    │
│ • Или Google Maps ссылку                │
│ • Или текст с адресом                   │
│                                         │
│ ⏱️ Жду 5 минут...                       │
└─────────────────────────────────────────┘

[📍 Отправить геолокацию]
[🔗 Отправить ссылку]
[💾 Сохранить без адреса]
[❌ Отмена]

───────────────────────────────────────────

👤 Клиент: 📍 [Геолокация: 7.2008, 79.8384]

🤖 Бот (моментально):

┌─────────────────────────────────────────┐
│ 📍 Местоположение получено!             │
│                                         │
│ ✅ Негомбо, Шри-Ланка                   │
│                                         │
│ 💬 Теперь отправь описание:             │
│ • Цена ($500)                           │
│ • Тип (studio/house/room)               │
│ • Контакт (+94 77 123 4567)             │
│                                         │
│ Или просто напиши всё что знаешь!       │
│                                         │
│ ⏱️ Жду 5 минут...                       │
└─────────────────────────────────────────┘

[💾 Сохранить без описания]
[❌ Отмена]

───────────────────────────────────────────

👤 Клиент: 
💬 "Studio $500/month
    Near beach, 2 min walk
    WiFi, AC, kitchen
    +94 77 123 4567"

🤖 Бот (через 2 сек):

┌─────────────────────────────────────────┐
│ ✅ Объект сохранён! (всего: 5)          │
│                                         │
│ 🏠 Studio, $500/месяц                   │
│ 📍 Негомбо, у моря                      │
│ 📸 3 фотографии                         │
│ 📞 +94 77 123 4567                      │
│                                         │
│ 🗺️ Ссылка:                             │
│ https://site.com/map/...                │
└─────────────────────────────────────────┘

[🗺️ Открыть карту] [⭐ В избранное]
[✏️ Заметка] [🗑️ Удалить]

──────────────────────────────────────────
КОНЕЦ ДИАЛОГА
```

---

### **ВАРИАНТ B: Геолокация → Фото → Описание**

```
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 1: Клиент отправляет ГЕОЛОКАЦИЮ                        │
└─────────────────────────────────────────────────────────────┘

👤 Клиент: 📍 [Геолокация: 6.1389, 80.1010]

🤖 Бот (моментально):

┌─────────────────────────────────────────┐
│ 📍 Местоположение получено!             │
│                                         │
│ ✅ Хиккадува, Шри-Ланка                 │
│                                         │
│ 📸 Теперь отправь фото объекта          │
│ (можно несколько, до 10 шт.)            │
│                                         │
│ ⏱️ Жду 5 минут...                       │
└─────────────────────────────────────────┘

[💾 Сохранить без фото]
[❌ Отмена]

───────────────────────────────────────────

👤 Клиент: 📸📸 [2 фотографии]

🤖 Бот:

┌─────────────────────────────────────────┐
│ 📸 Фото получены! (2 шт.)               │
│                                         │
│ 💬 Теперь отправь описание:             │
│ Цена, тип, контакт...                   │
│                                         │
│ ⏱️ Жду 5 минут...                       │
└─────────────────────────────────────────┘

[💾 Сохранить без описания]

───────────────────────────────────────────

👤 Клиент: 
💬 "House 2BR $800
    +94 77 999 8888"

🤖 Бот:

┌─────────────────────────────────────────┐
│ ✅ Объект сохранён! (всего: 6)          │
│                                         │
│ 🏠 House 2BR, $800/месяц                │
│ 📍 Хиккадува                            │
│ 📸 2 фотографии                         │
│ 📞 +94 77 999 8888                      │
│                                         │
│ 🗺️ https://site.com/map/...            │
└─────────────────────────────────────────┘

[🗺️ Открыть] [⭐ Избранное] [✏️ Заметка]

──────────────────────────────────────────
КОНЕЦ ДИАЛОГА
```

---

### **ВАРИАНТ C: Google Maps → Фото → Описание**

```
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 1: Клиент отправляет GOOGLE MAPS ССЫЛКУ               │
└─────────────────────────────────────────────────────────────┘

👤 Клиент: 
💬 "https://maps.app.goo.gl/Abc123"

🤖 Бот (через 1-2 сек):

┌─────────────────────────────────────────┐
│ 🔗 Google Maps ссылка получена!         │
│                                         │
│ ⏳ Извлекаю координаты...               │
└─────────────────────────────────────────┘

(через 2 сек)

┌─────────────────────────────────────────┐
│ ✅ Местоположение определено!           │
│                                         │
│ 📍 Негомбо, Gampaha District            │
│    (7.2008, 79.8384)                    │
│                                         │
│ 📸 Теперь отправь фото объекта          │
│                                         │
│ ⏱️ Жду 5 минут...                       │
└─────────────────────────────────────────┘

[💾 Сохранить без фото]
[❌ Отмена]

───────────────────────────────────────────

👤 Клиент: 📸📸📸 [3 фото]

🤖 Бот:

┌─────────────────────────────────────────┐
│ 📸 Фото получены! (3 шт.)               │
│                                         │
│ 💬 Добавь описание или сохраняй так     │
│                                         │
│ ⏱️ Жду 5 минут...                       │
└─────────────────────────────────────────┘

[💾 Сохранить сейчас]

───────────────────────────────────────────

👤 Клиент: 
💬 "Apartment 1BR $600"

🤖 Бот:

┌─────────────────────────────────────────┐
│ ✅ Объект сохранён! (всего: 7)          │
│                                         │
│ 🏠 Apartment 1BR, $600/месяц            │
│ 📍 Негомбо                              │
│ 📸 3 фотографии                         │
│                                         │
│ 🗺️ https://site.com/map/...            │
└─────────────────────────────────────────┘

[🗺️ Открыть] [⭐ Избранное]

──────────────────────────────────────────
КОНЕЦ ДИАЛОГА
```

---

### **ВАРИАНТ D: Текст с адресом → Фото**

```
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 1: Клиент отправляет ТЕКСТ С АДРЕСОМ                  │
└─────────────────────────────────────────────────────────────┘

👤 Клиент: 
💬 "Studio $500 Negombo beach area
    2 bedroom, wifi, AC
    +94 77 123 4567"

🤖 Бот (через 2 сек):

┌─────────────────────────────────────────┐
│ 💬 Описание получено!                   │
│                                         │
│ ✅ Распознано:                          │
│ 🏠 Тип: Studio                          │
│ 💰 Цена: $500                           │
│ 📍 Место: Negombo beach area            │
│ 🛏️ Спален: 2                            │
│ 📞 Контакт: +94 77 123 4567             │
│                                         │
│ ⏳ Определяю координаты...              │
└─────────────────────────────────────────┘

(через 2 сек)

┌─────────────────────────────────────────┐
│ ✅ Координаты определены!               │
│                                         │
│ 📍 Негомбо, пляжная зона                │
│    (7.2008, 79.8384)                    │
│                                         │
│ 📸 Отправь фото объекта                 │
│                                         │
│ ⏱️ Жду 5 минут...                       │
└─────────────────────────────────────────┘

[💾 Сохранить без фото]
[📍 Уточнить адрес]
[❌ Отмена]

───────────────────────────────────────────

👤 Клиент: 📸📸 [2 фото]

🤖 Бот:

┌─────────────────────────────────────────┐
│ ✅ Объект сохранён! (всего: 8)          │
│                                         │
│ 🏠 Studio 2BR, $500/месяц               │
│ 📍 Негомбо, у пляжа                     │
│ 📸 2 фотографии                         │
│ 📞 +94 77 123 4567                      │
│                                         │
│ 🗺️ https://site.com/map/...            │
└─────────────────────────────────────────┘

[🗺️ Открыть] [⭐ Избранное]

──────────────────────────────────────────
КОНЕЦ ДИАЛОГА
```

---

## ⏱️ ТАЙМАУТЫ И ОТМЕНЫ

### **Если клиент не отвечает 5 минут:**

```
(Прошло 5 минут после запроса фото/описания)

🤖 Бот:

┌─────────────────────────────────────────┐
│ ⏱️ Время ожидания истекло               │
│                                         │
│ ❓ Что делать с объектом?               │
│                                         │
│ У меня есть:                            │
│ 📍 Местоположение ✅                    │
│ 📸 Фото ❌                              │
│ 💬 Описание ❌                          │
└─────────────────────────────────────────┘

[💾 Сохранить как есть]
[🔄 Продолжить добавление]
[❌ Отменить]
```

---

### **Если клиент нажал "❌ Отмена":**

```
👤 Клиент: [Нажал "❌ Отмена"]

🤖 Бот:

┌─────────────────────────────────────────┐
│ ❌ Добавление объекта отменено          │
│                                         │
│ Данные удалены                          │
│                                         │
│ 💡 Начни заново когда будешь готов!    │
└─────────────────────────────────────────┘

[🏠 Главное меню]
```

---

## 🔄 ДОПОЛНИТЕЛЬНЫЕ ДАННЫЕ ПОСЛЕ СОХРАНЕНИЯ

### **Клиент может добавить данные ПОСЛЕ сохранения:**

```
🤖 Бот (после сохранения):

┌─────────────────────────────────────────┐
│ ✅ Объект сохранён! (всего: 5)          │
│                                         │
│ 🏠 Studio, $500/месяц                   │
│ 📍 Негомбо                              │
│                                         │
│ 💡 Хочешь добавить ещё что-то?          │
└─────────────────────────────────────────┘

[📸 Добавить фото]
[✏️ Изменить описание]
[📍 Уточнить адрес]
[⭐ В избранное]
[✅ Готово]

───────────────────────────────────────────

👤 Клиент: [Нажал "📸 Добавить фото"]

🤖 Бот:

┌─────────────────────────────────────────┐
│ 📸 Отправь дополнительные фото          │
│                                         │
│ Они добавятся к объекту:                │
│ 🏠 Studio $500, Негомбо                 │
└─────────────────────────────────────────┘

───────────────────────────────────────────

👤 Клиент: 📸📸 [2 фото]

🤖 Бот:

┌─────────────────────────────────────────┐
│ ✅ Фото добавлены! (всего: 2)           │
│                                         │
│ 🗺️ Объект обновлён на карте            │
└─────────────────────────────────────────┘

[🗺️ Открыть карту] [✅ Готово]
```

---

## 🎯 РЕКОМЕНДУЕМАЯ ЛОГИКА

### **По умолчанию: РЕЖИМ 1 (Forward)** ⚡

```
👤 Клиент: [Forward полного сообщения]
           📸📸 + 💬 текст + 📍 геолокация

🤖 Бот: ✅ Сохранено за 1 шаг!

БЫСТРО И ПРОСТО!
```

---

### **Если пошаговый режим: РЕЖИМ 2** 📝

```
ШАГ 1: Клиент отправляет ЧТО-ТО (фото/геолокация/текст)
       ↓
       🤖 Бот: "Получил X, теперь отправь Y"
       
ШАГ 2: Клиент отправляет Y
       ↓
       🤖 Бот: "Получил Y, теперь отправь Z"
       
ШАГ 3: Клиент отправляет Z
       ↓
       🤖 Бот: "✅ Сохранено!"

ГИБКО И ПОНЯТНО!
```

---

## 💾 СОСТОЯНИЕ СЕССИИ (State Management)

```typescript
// Хранение состояния пользователя

interface UserSession {
  userId: number;
  state: 'idle' | 'awaiting_location' | 'awaiting_photos' | 'awaiting_description';
  tempData: {
    photos?: string[];
    latitude?: number;
    longitude?: number;
    description?: string;
    googleMapsUrl?: string;
  };
  lastActivity: Date;
  timeout: NodeJS.Timeout;
}

// В памяти (можно в Redis для production)
const userSessions = new Map<number, UserSession>();

// Функция обработки
async function handleUserMessage(message: TelegramMessage) {
  const userId = message.from.id;
  let session = userSessions.get(userId);
  
  // Если нет сессии - создаём
  if (!session) {
    session = {
      userId,
      state: 'idle',
      tempData: {},
      lastActivity: new Date(),
      timeout: null
    };
    userSessions.set(userId, session);
  }
  
  // Обрабатываем по состоянию
  switch (session.state) {
    case 'idle':
      // Первое сообщение - определяем что пришло
      if (message.photo) {
        session.tempData.photos = await downloadPhotos(message.photo);
        session.state = 'awaiting_location';
        await sendMessage(userId, '📸 Фото получены! Теперь отправь геолокацию...');
        setSessionTimeout(session);
      }
      else if (message.location) {
        session.tempData.latitude = message.location.latitude;
        session.tempData.longitude = message.location.longitude;
        session.state = 'awaiting_photos';
        await sendMessage(userId, '📍 Местоположение получено! Теперь фото...');
        setSessionTimeout(session);
      }
      // ... и т.д.
      break;
      
    case 'awaiting_location':
      // Ждали локацию, пришла локация?
      if (message.location) {
        session.tempData.latitude = message.location.latitude;
        session.tempData.longitude = message.location.longitude;
        session.state = 'awaiting_description';
        await sendMessage(userId, '📍 Местоположение получено! Теперь описание...');
      } else {
        await sendMessage(userId, '⚠️ Жду геолокацию! Отправь точку на карте');
      }
      break;
      
    case 'awaiting_photos':
      if (message.photo) {
        session.tempData.photos = await downloadPhotos(message.photo);
        session.state = 'awaiting_description';
        await sendMessage(userId, '📸 Фото получены! Теперь описание...');
      }
      break;
      
    case 'awaiting_description':
      if (message.text) {
        session.tempData.description = message.text;
        
        // ВСЁ СОБРАНО! СОХРАНЯЕМ!
        await savePropertyFromSession(session);
        
        // Очищаем сессию
        clearSession(userId);
        
        await sendMessage(userId, '✅ Объект сохранён!');
      }
      break;
  }
}

// Таймаут сессии (5 минут)
function setSessionTimeout(session: UserSession) {
  if (session.timeout) {
    clearTimeout(session.timeout);
  }
  
  session.timeout = setTimeout(() => {
    sendMessage(session.userId, '⏱️ Время ожидания истекло. Начни заново!');
    clearSession(session.userId);
  }, 5 * 60 * 1000); // 5 минут
}

function clearSession(userId: number) {
  const session = userSessions.get(userId);
  if (session?.timeout) {
    clearTimeout(session.timeout);
  }
  userSessions.delete(userId);
}
```

---

## ✅ ИТОГОВАЯ СХЕМА

```
┌─────────────────────────────────────────┐
│  КЛИЕНТ ОТПРАВЛЯЕТ                      │
└─────────────────────────────────────────┘
           │
           ├─ Forward полное → ✅ Сохранить сразу (РЕЖИМ 1)
           │
           └─ Отдельное сообщение → Начать диалог (РЕЖИМ 2)
                     │
                     ├─ Фото → Жду локацию → Жду описание → ✅ Сохранить
                     ├─ Локация → Жду фото → Жду описание → ✅ Сохранить
                     ├─ Google Maps → Жду фото → Жду описание → ✅ Сохранить
                     └─ Текст → Жду локацию → Жду фото → ✅ Сохранить
                     
                     (Таймаут 5 мин на каждом шаге)
```

---

**Понятна логика диалога? Начинаем создавать код?** 🚀