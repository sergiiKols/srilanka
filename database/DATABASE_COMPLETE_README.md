# üìö –ü–æ–ª–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—é

## üéØ –ß—Ç–æ —Å–æ–∑–¥–∞–Ω–æ

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª **`FULL_DATABASE_SCHEMA.sql`** - –ø–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –∞—Ä–µ–Ω–¥—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ –®—Ä–∏-–õ–∞–Ω–∫–µ.

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### **4 –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**

#### 1Ô∏è‚É£ **`tenants`** - –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä—ã
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ Telegram-–±–æ—Ç–∞
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞—Ä—Ç–∞–º (6 —Å–∏–º–≤–æ–ª–æ–≤)
- –°—á—ë—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤

#### 2Ô∏è‚É£ **`saved_properties`** - –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ
- –¶–µ–Ω—ã —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤ USD
- –§–∏–ª—å—Ç—Ä—ã: –±–∞—Å—Å–µ–π–Ω, –ø–∞—Ä–∫–æ–≤–∫–∞, –ø–ª—è–∂, –∫—É—Ö–Ω—è –∏ —Ç.–¥.
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ—Å—ã–ª–æ–∫ –∏–∑ Telegram
- Soft delete (—É–¥–∞–ª–µ–Ω–∏–µ –±–µ–∑ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è)

#### 3Ô∏è‚É£ **`archived_properties`** - –ê—Ä—Ö–∏–≤ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
- –ö–æ–ø–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –∏–∑ `saved_properties`
- –ü—Ä–∏—á–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏ –¥–∞—Ç–∞
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω)

#### 4Ô∏è‚É£ **`pois`** - Points of Interest (—Å–ø–∞—Ä—à–µ–Ω–Ω—ã–µ POI)
- –†–µ—Å—Ç–æ—Ä–∞–Ω—ã, –ø–ª—è–∂–∏, —Ö—Ä–∞–º—ã, –±–æ–ª—å–Ω–∏—Ü—ã, –º–∞–≥–∞–∑–∏–Ω—ã
- 7 —Å–ª–æ—ë–≤ –∫–∞—Ä—Ç—ã: food, beach, culture, medical, transport, shopping, entertainment
- –†–µ–π—Ç–∏–Ω–≥–∏, —Ñ–æ—Ç–æ, –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã
- Quality score (–æ—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö)
- –ò—Å—Ç–æ—á–Ω–∏–∫–∏: OpenStreetMap, Google Places, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–∏ –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã

### **–§—É–Ω–∫—Ü–∏–∏:**
1. `generate_token_6chars()` - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –¥–æ—Å—Ç—É–ø–∞
2. `archive_property(uuid, reason, user_id)` - –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
3. `restore_property(uuid, user_id)` - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –∞—Ä—Ö–∏–≤–∞
4. `get_properties_by_price_usd(min, max)` - –§–∏–ª—å—Ç—Ä –ø–æ —Ü–µ–Ω–µ –≤ USD
5. `find_pois_nearby(lat, lon, radius_km, layer)` - –ü–æ–∏—Å–∫ POI –≤ —Ä–∞–¥–∏—É—Å–µ

### **–¢—Ä–∏–≥–≥–µ—Ä—ã:**
1. `update_updated_at_column()` - –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
2. `update_tenants_properties_count()` - –°—á—ë—Ç—á–∏–∫ –æ–±—ä–µ–∫—Ç–æ–≤ —É –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞
3. `calculate_price_usd()` - –ê–≤—Ç–æ–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ü–µ–Ω –≤ USD

---

## üìà Views (–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è)

1. **`properties_with_prices`** - –¶–µ–Ω—ã –≤ —Ä–∞–∑–Ω—ã—Ö –≤–∞–ª—é—Ç–∞—Ö (USD, LKR, EUR)
2. **`archive_statistics`** - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
3. **`pois_by_layer`** - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ POI –ø–æ —Å–ª–æ—è–º

---

## üóÇÔ∏è Storage (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ)

**Bucket: `tenant-photos`**
- –ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –Ω–∞ —á—Ç–µ–Ω–∏–µ
- –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –¥–æ 5MB
- –§–æ—Ä–º–∞—Ç—ã: JPEG, PNG, WebP
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞: `{user_id}/{property_id}/{photo.jpg}`

---

## üöÄ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ

### **–°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ Supabase Dashboard**
```bash
1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard
2. SQL Editor ‚Üí New Query
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ FULL_DATABASE_SCHEMA.sql
4. –ù–∞–∂–º–∏—Ç–µ RUN
```

### **–°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ CLI**
```bash
supabase db push --db-url "postgresql://..."
```

### **–°–ø–æ—Å–æ–± 3: –ß–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏ (–ø–æ –ø–æ—Ä—è–¥–∫—É)**
```bash
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ñ–∞–π–ª—ã –ø–æ –ø–æ—Ä—è–¥–∫—É:
database/00_INIT_DATABASE.sql
database/01_create_tenants_table.sql
database/02_create_token_function.sql
database/03_create_saved_properties_table.sql
database/04_create_storage_bucket.sql
database/05_add_soft_delete_to_saved_properties.sql
database/06_create_archived_properties_table.sql
database/07_setup_archive_logic.sql
database/08_fix_storage_policies.sql
database/09_add_property_filters.sql
database/10_add_price_usd_column.sql
database/11_create_cron_jobs_system.sql
database/12_add_video_support.sql
database/13_change_video_to_array.sql
```

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞—Ç—å –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞:
```sql
INSERT INTO tenants (telegram_user_id, map_secret_token)
VALUES (1234567890, generate_token_6chars());
```

### –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏:
```sql
INSERT INTO saved_properties (
  telegram_user_id, latitude, longitude,
  title, price, currency, photos
) VALUES (
  1234567890, 6.9271, 79.8612,
  'Beach villa', 50000, 'LKR',
  ARRAY['https://example.com/photo1.jpg']
);
```

### –ù–∞–π—Ç–∏ –æ–±—ä–µ–∫—Ç—ã –ø–æ —Ü–µ–Ω–µ ($200-$500):
```sql
SELECT * FROM get_properties_by_price_usd(200, 500);
```

### –ù–∞–π—Ç–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã –≤ —Ä–∞–¥–∏—É—Å–µ 1 –∫–º:
```sql
SELECT * FROM find_pois_nearby(6.9271, 79.8612, 1.0, 'food');
```

### –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç:
```sql
SELECT archive_property(
  '550e8400-e29b-41d4-a716-446655440000'::uuid,
  'user_deleted',
  1234567890
);
```

---

## üîç –ò–Ω–¥–µ–∫—Å—ã

–í—Å–µ –≤–∞–∂–Ω—ã–µ –ø–æ–ª—è –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞:
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (latitude, longitude)
- Telegram User ID
- –¶–µ–Ω—ã (price_usd)
- –§–∏–ª—å—Ç—Ä—ã (pool, parking, beachfront)
- POI —Å–ª–æ–∏ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- –î–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è/–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **RLS (Row Level Security)** –¥–ª—è –∞—Ä—Ö–∏–≤–∞
- **Storage Policies** –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
- **Soft Delete** –≤–º–µ—Å—Ç–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
- **–¢—Ä–∏–≥–≥–µ—Ä—ã** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏

---

## üìä –°–ª–æ–∏ POI (7 —Å–ª–æ—ë–≤)

1. **üçΩÔ∏è food** - –†–µ—Å—Ç–æ—Ä–∞–Ω—ã, –∫–∞—Ñ–µ, –º–∞–≥–∞–∑–∏–Ω—ã
2. **üèñÔ∏è beach** - –ü–ª—è–∂–∏, —Å—ë—Ä—Ñ–∏–Ω–≥, –¥–∞–π–≤–∏–Ω–≥
3. **üèõÔ∏è culture** - –•—Ä–∞–º—ã, –º—É–∑–µ–∏, –ø–∞–º—è—Ç–Ω–∏–∫–∏
4. **üè• medical** - –ë–æ–ª—å–Ω–∏—Ü—ã, –∞–ø—Ç–µ–∫–∏
5. **üöå transport** - –ê–≤—Ç–æ–±—É—Å—ã, —Ç–∞–∫—Å–∏, –ø—Ä–æ–∫–∞—Ç
6. **üõçÔ∏è shopping** - –¢–æ—Ä–≥–æ–≤—ã–µ —Ü–µ–Ω—Ç—Ä—ã, —Ä—ã–Ω–∫–∏
7. **üé≠ entertainment** - –°–ü–ê, –π–æ–≥–∞, –∫–ª—É–±—ã

–ü–æ–¥—Ä–æ–±–Ω–µ–µ –≤ **`POI_LAYERS_INFO.md`**

---

## üì¶ –†–∞–∑–º–µ—Ä –±–∞–∑—ã (–ø—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞)

- **tenants:** ~1000 –∑–∞–ø–∏—Å–µ–π = 100 KB
- **saved_properties:** ~10,000 –∑–∞–ø–∏—Å–µ–π = 5 MB
- **archived_properties:** ~2,000 –∑–∞–ø–∏—Å–µ–π = 1 MB
- **pois:** ~50,000 –∑–∞–ø–∏—Å–µ–π = 25 MB
- **Storage (photos):** –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ò—Ç–æ–≥–æ:** ~30-50 MB (–±–µ–∑ —Ñ–æ—Ç–æ)

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public'
ORDER BY table_name;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏
SELECT routine_name 
FROM information_schema.routines 
WHERE routine_schema = 'public'
ORDER BY routine_name;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã
SELECT trigger_name, event_object_table
FROM information_schema.triggers
WHERE trigger_schema = 'public'
ORDER BY trigger_name;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
SELECT indexname, tablename
FROM pg_indexes
WHERE schemaname = 'public'
ORDER BY tablename, indexname;
```

---

## üîß –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–§–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ `database/`:
- ‚úÖ `FULL_DATABASE_SCHEMA.sql` - –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ (–æ–¥–∏–Ω —Ñ–∞–π–ª)
- ‚úÖ `POI_LAYERS_INFO.md` - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ª–æ—è—Ö POI
- ‚úÖ `01-13_*.sql` - –û—Ç–¥–µ–ª—å–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (–¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è)
- ‚úÖ `README.md` - –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

---

## üéâ –ì–æ—Ç–æ–≤–æ!

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ. –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã, –∏–Ω–¥–µ–∫—Å—ã, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã.
