# 👤 ЛОГИКА РАБОТЫ АРЕНДАТОРА - Полный процесс

**Дата:** 2026-01-29  
**Система:** Telegram Bot "Записная книжка объектов"

---

## 🎯 КОНЦЕПЦИЯ

Арендатор использует Telegram бота как **личную записную книжку** для сохранения интересных объектов недвижимости.

**Принцип:** "Нашёл → Переслал боту → Сохранено на карте"

---

## 📱 ПОЛНЫЙ FLOW АРЕНДАТОРА

### **СЦЕНАРИЙ 1: Первое использование (новый пользователь)**

```
┌─────────────────────────────────────────────────────────────┐
│  👤 Пользователь: Иван                                      │
│  📱 Telegram ID: 1000089271                                 │
│  📅 Дата: 2026-01-29 14:00                                  │
└─────────────────────────────────────────────────────────────┘

ШАГ 1: Иван находит объявление в группе "Жильё Шри-Ланка"
───────────────────────────────────────────────────────────────
📨 Сообщение в группе:
   📸📸 [2 фотографии студии]
   💬 "Студия возле моря, $500/месяц
       2 минуты до пляжа Негомбо
       Wi-Fi, кондиционер, кухня
       📞 +94 77 123 4567"

ШАГ 2: Иван пересылает (forward) это сообщение боту
───────────────────────────────────────────────────────────────
👤 Иван → 🤖 @YourPropertyBot
   [Forwarded from "Жильё Шри-Ланка"]
   📸📸 + текст

⚙️ БОТ ОБРАБАТЫВАЕТ:
   1. Видит что это forward из группы
   2. Проверяет: есть ли Иван в БД?
      → НЕТ! Это первый раз
   
   3. СОЗДАЁТ НОВОГО TENANT:
      ├── telegram_user_id: 1000089271
      ├── map_secret_token: "aB7cDx" (генерирует случайно)
      └── personal_map_url: "/map/personal/1000089271/aB7cDx"
   
   4. ПАРСИТ FORWARD МЕТАДАННЫЕ:
      ├── source_type: "forward_channel"
      ├── forward_from_chat_title: "Жильё Шри-Ланка"
      ├── forward_from_chat_username: "srilanka_housing"
      ├── forward_from_message_id: 12345
      └── original_message_link: "https://t.me/srilanka_housing/12345"
   
   5. ПАРСИТ ОПИСАНИЕ:
      ├── price: 500
      ├── currency: "USD"
      ├── property_type: "studio"
      ├── contact_phone: "+94 77 123 4567"
      └── amenities: ["Wi-Fi", "кондиционер", "кухня"]
   
   6. СКАЧИВАЕТ ФОТО ИЗ TELEGRAM:
      ├── Фото 1: https://api.telegram.org/file/bot.../photo1.jpg
      └── Фото 2: https://api.telegram.org/file/bot.../photo2.jpg
   
   7. ЗАГРУЖАЕТ В SUPABASE STORAGE:
      ├── tenant-photos/1000089271/uuid-1/photo_1.jpg
      └── tenant-photos/1000089271/uuid-1/photo_2.jpg
      
      Публичные URL:
      ├── https://xxx.supabase.co/storage/.../photo_1.jpg
      └── https://xxx.supabase.co/storage/.../photo_2.jpg
   
   8. ОПРЕДЕЛЯЕТ КООРДИНАТЫ:
      Вариант A: Если в сообщении была геолокация → использует её
      Вариант B: Если в тексте "Негомбо" → геокодирует через API
      Вариант C: Дефолт Коломбо (6.9271, 79.8612)
      
      Результат: latitude: 7.2008, longitude: 79.8384 (Негомбо)
   
   9. СОХРАНЯЕТ В saved_properties:
      ├── telegram_user_id: 1000089271
      ├── title: "Studio"
      ├── description: "Студия возле моря, $500/месяц..."
      ├── latitude: 7.2008
      ├── longitude: 79.8384
      ├── price: 500
      ├── currency: "USD"
      ├── property_type: "studio"
      ├── photos: [url1, url2]
      ├── contact_phone: "+94 77 123 4567"
      ├── source_type: "forward_channel"
      ├── forward_from_chat_title: "Жильё Шри-Ланка"
      └── forward_from_message_id: 12345
   
   10. ТРИГГЕР АВТОМАТИЧЕСКИ ОБНОВЛЯЕТ СЧЁТЧИК:
       tenants.saved_properties_count: 0 → 1

ШАГ 3: Иван получает ответ от бота (через 2-3 секунды)
───────────────────────────────────────────────────────────────
🤖 Бот → 👤 Иван:

   ✅ Объект сохранён! (всего: 1)
   
   🗺️ Ваша карта:
   https://your-site.com/map/personal/1000089271/aB7cDx
   
   💡 Пересылайте сюда объявления - они автоматически 
   добавятся на карту!

ШАГ 4: Иван открывает ссылку на карту
───────────────────────────────────────────────────────────────
🌐 Browser → /map/personal/1000089271/aB7cDx

✅ Проверка доступа:
   1. Извлекает userId: 1000089271
   2. Извлекает token: "aB7cDx"
   3. Проверяет в БД:
      SELECT * FROM tenants 
      WHERE telegram_user_id = 1000089271 
      AND map_secret_token = 'aB7cDx'
   
   4. Нашёл! Доступ разрешён ✅
   5. Логирует попытку в access_attempts (success: true)

📍 ИВАН ВИДИТ СВОЮ КАРТУ:
   ┌──────────────────────────────────────┐
   │  🏠 Моя карта (1 объект)             │
   ├──────────────────────────────────────┤
   │                                      │
   │    🗺️ [Интерактивная карта]         │
   │                                      │
   │    📍 Маркер на карте (Негомбо)     │
   │       [Клик открывает попап]         │
   │                                      │
   │    ┌────────────────────────────┐   │
   │    │ 📸📸 [Фото студии]         │   │
   │    │ $500 Studio                │   │
   │    │ Негомбо, у моря            │   │
   │    │                            │   │
   │    │ 📞 +94 77 123 4567         │   │
   │    │ 📨 От: "Жильё Шри-Ланка"  │   │
   │    │                            │   │
   │    │ [⭐ Избранное]             │   │
   │    │ [📝 Заметка]               │   │
   │    │ [🗑️ Удалить]               │   │
   │    └────────────────────────────┘   │
   └──────────────────────────────────────┘

КОНЕЦ ПЕРВОГО ИСПОЛЬЗОВАНИЯ
```

---

### **СЦЕНАРИЙ 2: Добавление второго объекта (через 2 дня)**

```
┌─────────────────────────────────────────────────────────────┐
│  👤 Пользователь: Иван (уже зарегистрирован)               │
│  📅 Дата: 2026-01-31 10:00                                  │
└─────────────────────────────────────────────────────────────┘

ШАГ 1: Иван видит объявление от знакомого в личке
───────────────────────────────────────────────────────────────
👨 Друг → 👤 Иван:
   "Слушай, у меня освобождается дом в Хиккадуве
    2 спальни, $800, хочешь?"
    📸 [1 фото дома]
    📍 [Геолокация: 6.1389, 80.1010]

ШАГ 2: Иван пересылает сообщение боту
───────────────────────────────────────────────────────────────
👤 Иван → 🤖 Бот
   [Forwarded from "Друг"]
   📸 + 📍 геолокация

⚙️ БОТ ОБРАБАТЫВАЕТ:
   1. Проверяет: есть ли Иван в БД?
      → ДА! tenant_id: 1000089271, token: "aB7cDx"
   
   2. ОБНОВЛЯЕТ last_active_at
   
   3. ПАРСИТ FORWARD МЕТАДАННЫЕ:
      ├── source_type: "forward_user"
      ├── forward_from_user_id: 987654321
      ├── forward_from_first_name: "Друг"
      └── forward_date: 2026-01-31T10:00:00Z
   
   4. ПАРСИТ ОПИСАНИЕ:
      ├── price: 800
      ├── property_type: "house"
      └── bedrooms: 2
   
   5. ИСПОЛЬЗУЕТ ГЕОЛОКАЦИЮ:
      ├── latitude: 6.1389
      ├── longitude: 80.1010
      └── address: "Hikkaduwa" (геокодирование обратное)
   
   6. ЗАГРУЖАЕТ ФОТО:
      └── tenant-photos/1000089271/uuid-2/photo_1.jpg
   
   7. СОХРАНЯЕТ В saved_properties
   
   8. ТРИГГЕР: saved_properties_count: 1 → 2

ШАГ 3: Иван получает ответ
───────────────────────────────────────────────────────────────
🤖 Бот → 👤 Иван:

   ✅ Объект сохранён! (всего: 2)
   
   🗺️ Ваша карта:
   https://your-site.com/map/personal/1000089271/aB7cDx

ШАГ 4: Иван открывает карту
───────────────────────────────────────────────────────────────
📍 ИВАН ВИДИТ УЖЕ 2 ОБЪЕКТА:

   🗺️ Карта Шри-Ланки
      │
      ├── 📍 Негомбо (Studio, $500)
      │   └── Добавлено: 2 дня назад
      │
      └── 📍 Хиккадува (House 2BR, $800)
          └── Добавлено: только что

ДЕЙСТВИЯ ИВАНА:
   1. Кликает на маркер в Негомбо
      → Видит фото, описание, контакты
   
   2. Нажимает ⭐ "Избранное"
      → saved_properties.is_favorite = true
   
   3. Нажимает 📝 "Заметка"
      → Добавляет: "Позвонить завтра утром"
      → saved_properties.notes = "Позвонить завтра..."
```

---

### **СЦЕНАРИЙ 3: Добавление через 2 недели (активный пользователь)**

```
┌─────────────────────────────────────────────────────────────┐
│  👤 Пользователь: Иван (опытный пользователь)              │
│  📅 Дата: 2026-02-14                                        │
│  📊 Статистика: 12 объектов сохранено                       │
└─────────────────────────────────────────────────────────────┘

У ИВАНА УЖЕ 12 ОБЪЕКТОВ НА КАРТЕ:
   ├── 3 студии в Негомбо ($400-$600)
   ├── 2 дома в Хиккадуве ($800-$1000)
   ├── 4 комнаты в Коломбо ($200-$350)
   ├── 2 виллы в Галле ($1500-$2000)
   └── 1 апартамент в Канди ($450)

КАРТА ИВАНА:
   ┌──────────────────────────────────────┐
   │  🏠 Моя карта (12 объектов)          │
   ├──────────────────────────────────────┤
   │                                      │
   │  🗺️ [Карта с 12 маркерами]          │
   │                                      │
   │  Фильтры:                            │
   │  💰 Цена: $200 - $2000               │
   │  🏠 Тип: Все                         │
   │  ⭐ Только избранные (3)             │
   │                                      │
   │  📊 Статистика:                      │
   │  ├── Средняя цена: $683              │
   │  ├── Добавлено за неделю: 5          │
   │  └── Источников: 8 (4 группы + 4 др) │
   └──────────────────────────────────────┘

ДЕЙСТВИЯ ИВАНА:
   1. Удаляет старые объекты (уже сняты)
      → saved_properties_count: 12 → 10
   
   2. Отмечает 3 объекта как избранные ⭐
   
   3. Добавляет заметки к каждому
   
   4. Делится ссылкой с женой:
      "Смотри мою подборку: 
       https://your-site.com/map/personal/1000089271/aB7cDx"
   
   5. Жена открывает → видит ТУ ЖЕ карту
      (доступ через секретный токен)
```

---

## 🔄 ТИПИЧНЫЕ СЦЕНАРИИ ИСПОЛЬЗОВАНИЯ

### **Сценарий A: Активный поиск**
```
👤 Пользователь ищет жильё на 2 месяца

День 1: Находит 5 объектов → пересылает боту
День 2: Добавляет ещё 3 объекта
День 3: Удаляет 2 неподходящих
День 4: Отмечает 3 лучших как ⭐ избранные
День 5: Звонит по избранным, снимает один

Итог: 6 объектов на карте, 1 снят ✅
```

### **Сценарий B: Пассивный мониторинг**
```
👤 Пользователь планирует переезд через 3 месяца

Неделя 1: Добавляет 2 объекта
Неделя 2: Добавляет 1 объект
Неделя 3: Ничего не добавляет
Неделя 4: Добавляет 3 объекта

Через 3 месяца: 15 объектов на карте
→ Выбирает лучший вариант из всех ✅
```

### **Сценарий C: Помощь другу**
```
👤 Пользователь помогает другу найти жильё

День 1: Видит объявление → пересылает боту
День 2: Отправляет ссылку на карту другу
Друг: Открывает карту → видит все варианты
Друг: Выбирает подходящий → звонит

Итог: Помог другу без пересылки кучи сообщений ✅
```

---

## 📊 ДАННЫЕ КОТОРЫЕ ВИДИТ АРЕНДАТОР

### На каждом объекте на карте:

```
┌────────────────────────────────────────┐
│ 📸📸 [Фотографии]                      │
│                                        │
│ 🏠 $500 Studio                         │
│ 📍 Негомбо, возле моря                 │
│                                        │
│ ℹ️ Описание:                           │
│ "Студия 2 минуты до пляжа              │
│  Wi-Fi, кондиционер, кухня"            │
│                                        │
│ 📞 Контакт: +94 77 123 4567            │
│                                        │
│ 📨 Источник:                           │
│ "Жильё Шри-Ланка" (группа)             │
│ 🔗 [Перейти к оригиналу]               │
│                                        │
│ 📅 Добавлено: 2 дня назад              │
│                                        │
│ 📝 Моя заметка:                        │
│ "Позвонить завтра утром"               │
│                                        │
│ [⭐ В избранное] [🗑️ Удалить]          │
└────────────────────────────────────────┘
```

---

## 🎯 КЛЮЧЕВЫЕ ПРЕИМУЩЕСТВА ДЛЯ АРЕНДАТОРА

### ✅ Простота
- Не нужно регистрироваться
- Просто переслал → сохранено
- Одна ссылка на все объекты

### ✅ Удобство
- Все объекты на одной карте
- Видно расположение
- Можно сравнивать

### ✅ Организация
- Заметки к каждому объекту
- Избранные
- Фильтры

### ✅ Конфиденциальность
- Личная карта (секретный токен)
- Только вы видите свои объекты
- Можно делиться ссылкой

---

## 🔐 БЕЗОПАСНОСТЬ

### Защита доступа:
```
URL: /map/personal/1000089271/aB7cDx
                    ↑          ↑
                    userId     токен (62^6 комбинаций)

Без токена → доступ запрещён ❌
С токеном → доступ разрешён ✅
```

### Логирование:
```sql
-- Каждый доступ логируется
INSERT INTO access_attempts (
  telegram_user_id,
  success,
  created_at
) VALUES (
  1000089271,
  true,
  NOW()
);
```

---

## 📱 ПРИМЕР ДИАЛОГА С БОТОМ

```
👤 Иван: [Forward сообщение с фото]

🤖 Бот (через 2 сек):
    ✅ Объект сохранён! (всего: 1)
    🗺️ https://your-site.com/map/personal/1000089271/aB7cDx

───────────────────────────────────────

👤 Иван: [Forward ещё одно]

🤖 Бот:
    ✅ Объект сохранён! (всего: 2)
    🗺️ https://your-site.com/map/personal/1000089271/aB7cDx

───────────────────────────────────────

👤 Иван: /start

🤖 Бот:
    👋 Привет! Я помогу сохранить объекты недвижимости.
    
    Просто пересылай мне объявления - они автоматически
    добавятся на твою личную карту!
    
    🗺️ Твоя карта: https://your-site.com/map/personal/1000089271/aB7cDx
    📊 Сохранено: 2 объекта

───────────────────────────────────────

👤 Иван: /stats

🤖 Бот:
    📊 Твоя статистика:
    
    Всего объектов: 2
    ⭐ Избранных: 0
    📅 Добавлено сегодня: 2
    📍 Городов: 2 (Негомбо, Хиккадува)
    💰 Средняя цена: $650
    
    🗺️ Карта: https://your-site.com/map/personal/1000089271/aB7cDx
```

---

## ✅ ИТОГО - ЧТО ПОЛУЧАЕТ АРЕНДАТОР

1. **Личную записную книжку** объектов в Telegram
2. **Интерактивную карту** со всеми сохранёнными объектами
3. **Автоматическую организацию** (парсинг цены, типа, контактов)
4. **Историю источников** (кто прислал, из какой группы)
5. **Возможность делиться** (отправить ссылку другу)
6. **Приватность** (секретный токен)

**Всё это БЕЗ регистрации и заполнения форм!** 🎉

---

Понятна логика? Готовы начать создавать код? 🚀
