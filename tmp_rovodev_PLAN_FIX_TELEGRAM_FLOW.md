# üîß –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø TELEGRAM ‚Üí MAP FLOW

## üìä –¢–ï–ö–£–©–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- Telegram bot –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- –î–∞–Ω–Ω—ã–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ë–î `saved_properties`
- API `/api/saved-properties` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
- –ö–∞—Ä—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç –º–∞—Ä–∫–µ—Ä—ã (–Ω–æ –±–µ–∑ –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

### ‚ùå –ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. **–§–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è** - –±–µ—Ä—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ 1 —Ñ–æ—Ç–æ –≤–º–µ—Å—Ç–æ –≤—Å–µ—Ö
2. **–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–ø–∞–¥–∞–µ—Ç** - AI –Ω–µ –≤—Å–µ–≥–¥–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç
3. **–ö–Ω–æ–ø–∫–∞ Import –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** - –Ω–∞ —Å—Ç–∞—Ä–æ–π –∫–∞—Ä—Ç–µ
4. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç –∫–∞—Ä—Ç** - `/map` (—Å—Ç–∞—Ä–∞—è) vs `/admin/master-map` (–Ω–æ–≤–∞—è)

---

## üéØ –†–ï–®–ï–ù–ò–ï

### **–ü–†–û–ë–õ–ï–ú–ê 1: –§–û–¢–û –ù–ï –ó–ê–ì–†–£–ñ–ê–Æ–¢–°–Ø**

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** (—Å—Ç—Ä–æ–∫–∞ 157-168 –≤ webhook):
```typescript
if (message.photo && message.photo.length > 0) {
  console.log('üì∏ Uploading photos...');
  const bestPhoto = getBestQualityPhoto(message.photo); // ‚ùå –¢–û–õ–¨–ö–û 1 –§–û–¢–û
  photoUrls = await uploadTelegramPhotos(
    botToken,
    [bestPhoto],  // ‚ùå –ú–ê–°–°–ò–í –ò–ó 1 –≠–õ–ï–ú–ï–ù–¢–ê
    userId,
    propertyId,
    10  // ‚ùå limit –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
  );
  console.log(`‚úÖ Uploaded ${photoUrls.length} photos`);
}
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```typescript
if (message.photo && message.photo.length > 0) {
  console.log(`üì∏ Uploading ${message.photo.length} photos...`);
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï —Ñ–æ—Ç–æ –∏–∑ –º–∞—Å—Å–∏–≤–∞
  photoUrls = await uploadTelegramPhotos(
    botToken,
    message.photo,  // ‚úÖ –í–°–ï –§–û–¢–û
    userId,
    propertyId,
    message.photo.length  // ‚úÖ –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ
  );
  
  console.log(`‚úÖ Uploaded ${photoUrls.length} photos`);
}
```

**–ü–æ—á–µ–º—É –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ:**
- Telegram –≤ forwarded message –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –º–∞—Å—Å–∏–≤ `photo` —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ **–û–î–ù–û–ô —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏**
- `getBestQualityPhoto` –≤—ã–±–∏—Ä–∞–µ—Ç –ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ
- –ù–æ –µ—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ - –æ–Ω–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –∫–∞–∫ **media group** (–æ—Ç–¥–µ–ª—å–Ω—ã–π update)

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å **media_group_id** –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ
- –°–æ–±–∏—Ä–∞—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ –∏–∑ –≥—Ä—É–ø–ø—ã –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π

---

### **–ü–†–û–ë–õ–ï–ú–ê 2: –û–ü–ò–°–ê–ù–ò–ï –ù–ï –ü–ê–†–°–ò–¢–°–Ø AI**

**–¢–µ–∫—É—â–∏–π flow:**
1. –¢–µ–∫—Å—Ç ‚Üí AI analysis (`analyzeWithFallback`)
2. AI –∏–∑–≤–ª–µ–∫–∞–µ—Ç: title, price, property_type, coordinates
3. **–ù–û:** –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `description`

**–ö–æ–¥** (—Å—Ç—Ä–æ–∫–∞ 171-177):
```typescript
const propertyData = {
  ...formatForDatabase(aiResult),  // ‚ùå –¢—É—Ç –ù–ï–¢ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
  telegram_user_id: userId,
  photos: photoUrls,
  google_maps_url: googleMapsUrl || undefined,
  ...forwardMeta
};
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```typescript
const propertyData = {
  ...formatForDatabase(aiResult),
  telegram_user_id: userId,
  photos: photoUrls,
  google_maps_url: googleMapsUrl || undefined,
  description: text || aiResult.description,  // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
  raw_text: text,  // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–π raw text
  ...forwardMeta
};
```

---

### **–ü–†–û–ë–õ–ï–ú–ê 3: –ö–ù–û–ü–ö–ê IMPORT –ù–ï –†–ê–ë–û–¢–ê–ï–¢**

**–õ–æ–∫–∞—Ü–∏—è:** `src/components/PropertyImporter.tsx`

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** (—Å—Ç—Ä–æ–∫–∞ ~50-100):
```typescript
const handleImport = async () => {
  // –ö–æ–¥ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ property_listings —Ç–∞–±–ª–∏—Ü–µ
  // –ù–æ —Ç–µ–ø–µ—Ä—å –¥–∞–Ω–Ω—ã–µ –≤ saved_properties
};
```

**–†–µ—à–µ–Ω–∏–µ:**
–ù—É–∂–Ω–æ:
1. –õ–∏–±–æ –æ–±–Ω–æ–≤–∏—Ç—å PropertyImporter –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å `saved_properties`
2. –õ–∏–±–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
3. –õ–∏–±–æ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É Import (—Ç.–∫. –¥–∞–Ω–Ω—ã–µ —Ç–µ–ø–µ—Ä—å –∏–¥—É—Ç —á–µ—Ä–µ–∑ Telegram)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** 
- Import –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
- –¢–µ–ø–µ—Ä—å –≤—Å—ë —á–µ—Ä–µ–∑ Telegram bot
- **–†–µ—à–µ–Ω–∏–µ:** –£–±—Ä–∞—Ç—å Import —Å –∞–¥–º–∏–Ω—Å–∫–æ–π –∫–∞—Ä—Ç—ã, –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä

---

### **–ü–†–û–ë–õ–ï–ú–ê 4: –ö–û–ù–§–õ–ò–ö–¢ –ö–ê–†–¢**

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
- `/map` (—Å—Ç–∞—Ä–∞—è –∫–∞—Ä—Ç–∞) - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ 4 —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±—ä–µ–∫—Ç–∞
- `/admin/master-map` (–Ω–æ–≤–∞—è –∞–¥–º–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞) - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ

**–†–µ—à–µ–Ω–∏–µ - 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞:**

#### **–í–ê–†–ò–ê–ù–¢ A (–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ô):**
```
/map ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /admin/master-map
/admin/master-map ‚Üí –∞–¥–º–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞ —Å saved_properties
```

#### **–í–ê–†–ò–ê–ù–¢ B:**
```
/map ‚Üí –ø—É–±–ª–∏—á–Ω–∞—è –∫–∞—Ä—Ç–∞ (–≤—Å–µ –æ–±—ä–µ–∫—Ç—ã, –±–µ–∑ –∞–¥–º–∏–Ω —Ñ—É–Ω–∫—Ü–∏–π)
/admin/master-map ‚Üí –∞–¥–º–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞ (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π)
```

#### **–í–ê–†–ò–ê–ù–¢ C:**
```
/map ‚Üí —É–¥–∞–ª–∏—Ç—å —Å–æ–≤—Å–µ–º
/admin/master-map ‚Üí –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞
```

**–Ø —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –í–ê–†–ò–ê–ù–¢ A** - —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å–æ —Å—Ç–∞—Ä–æ–π –Ω–∞ –Ω–æ–≤—É—é.

---

## üìã –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### –®–ê–ì 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ñ–æ—Ç–æ (HIGH PRIORITY)
- [ ] –û–±—Ä–∞–±–æ—Ç–∞—Ç—å `media_group_id` –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ
- [ ] –ó–∞–≥—Ä—É–∂–∞—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ –∏–∑ –≥—Ä—É–ø–ø—ã
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –¥–ª—è —Å–±–æ—Ä–∞ –≤—Å–µ—Ö —Ñ–æ—Ç–æ –≥—Ä—É–ø–ø—ã (200ms)

### –®–ê–ì 2: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (HIGH PRIORITY)
- [ ] –î–æ–±–∞–≤–∏—Ç—å `description` –≤ propertyData
- [ ] –î–æ–±–∞–≤–∏—Ç—å `raw_text` –¥–ª—è full backup
- [ ] –û–±–Ω–æ–≤–∏—Ç—å —Å—Ö–µ–º—É –ë–î –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

### –®–ê–ì 3: –†–µ—à–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∫–∞—Ä—Ç (MEDIUM PRIORITY)
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å `/map` –Ω–∞ `/admin/master-map`
- [ ] –ò–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å `/map` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å `saved_properties`

### –®–ê–ì 4: –£–±—Ä–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å Import –∫–Ω–æ–ø–∫—É (LOW PRIORITY)
- [ ] –£–±—Ä–∞—Ç—å —Å –∞–¥–º–∏–Ω—Å–∫–æ–π –∫–∞—Ä—Ç—ã
- [ ] –ò–ª–∏ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å saved_properties

### –®–ê–ì 5: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å flow (CRITICAL)
- [ ] –û—Ç–ø—Ä–∞–≤–∏—Ç—å forward —Å 1 —Ñ–æ—Ç–æ ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
- [ ] –û—Ç–ø—Ä–∞–≤–∏—Ç—å media group (3+ —Ñ–æ—Ç–æ) ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ description —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ –∫–∞—Ä—Ç–∞—Ö

---

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### Media Group –æ–±—Ä–∞–±–æ—Ç–∫–∞

Telegram –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ:
```json
{
  "update_id": 123,
  "message": {
    "message_id": 456,
    "media_group_id": "12345",  // ‚Üê –ö–õ–Æ–ß–ï–í–û–ï –ü–û–õ–ï
    "photo": [...],
    "caption": "Text only on first photo"
  }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–∞–∂–¥–æ–µ —Ñ–æ—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π update!

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –•—Ä–∞–Ω–∏–º media groups –≤—Ä–µ–º–µ–Ω–Ω–æ
const mediaGroups = new Map<string, any[]>();

// –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ update —Å media_group_id:
if (message.media_group_id) {
  // –î–æ–±–∞–≤–ª—è–µ–º –≤ –≥—Ä—É–ø–ø—É
  const group = mediaGroups.get(message.media_group_id) || [];
  group.push(message);
  mediaGroups.set(message.media_group_id, group);
  
  // –ñ–¥—ë–º 200ms –¥–ª—è —Å–±–æ—Ä–∞ –≤—Å–µ—Ö —Ñ–æ—Ç–æ
  setTimeout(() => {
    const completeGroup = mediaGroups.get(message.media_group_id);
    if (completeGroup) {
      processMediaGroup(completeGroup);
      mediaGroups.delete(message.media_group_id);
    }
  }, 200);
}
```

---

## üéØ –ò–¢–û–ì–û–í–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

–ü–æ—Å–ª–µ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

‚úÖ **Telegram bot:**
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç forward —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Ñ–æ—Ç–æ
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –í–°–ï —Ñ–æ—Ç–æ –≤ Supabase Storage
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ + AI –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ Google Maps –∏–ª–∏ AI –∞–Ω–∞–ª–∏–∑–∞

‚úÖ **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
- `saved_properties` —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- `photos` –º–∞—Å—Å–∏–≤ —Å–æ –≤—Å–µ–º–∏ URL
- `description` —Å –∏—Å—Ö–æ–¥–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
- `raw_text` —Å backup

‚úÖ **–ö–∞—Ä—Ç—ã:**
- `/admin/master-map` - –µ–¥–∏–Ω–∞—è –∞–¥–º–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã —Å —Ñ–æ—Ç–æ
- PropertyDrawer —Å –ø–æ–ª–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º
- –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫

---

## ‚è±Ô∏è –û–¶–ï–ù–ö–ê –í–†–ï–ú–ï–ù–ò

| –ó–∞–¥–∞—á–∞ | –í—Ä–µ–º—è |
|--------|-------|
| –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ñ–æ—Ç–æ | 30 –º–∏–Ω |
| –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è | 15 –º–∏–Ω |
| –†–µ–¥–∏—Ä–µ–∫—Ç –∫–∞—Ä—Ç | 10 –º–∏–Ω |
| –£–±—Ä–∞—Ç—å Import –∫–Ω–æ–ø–∫—É | 5 –º–∏–Ω |
| –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | 30 –º–∏–Ω |
| **–ò–¢–û–ì–û** | **1.5 —á–∞—Å–∞** |

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

1. **–°–Ω–∞—á–∞–ª–∞ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ** - —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ
2. **–ü–æ—Ç–æ–º —Ä–µ—à–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∫–∞—Ä—Ç** - —Ä–µ–¥–∏—Ä–µ–∫—Ç –ø—Ä–æ—â–µ –≤—Å–µ–≥–æ
3. **Import –∫–Ω–æ–ø–∫—É –º–æ–∂–Ω–æ –ø–æ—Ç–æ–º** - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ

**–ù–∞—á–∏–Ω–∞–µ–º?** üöÄ
