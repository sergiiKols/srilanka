# ‚úÖ –†–ï–®–ï–ù–ò–ï: –ü—Ä–æ–±–ª–µ–º–∞ —Å –∞—Ä—Ö–∏–≤–∞—Ü–∏–µ–π –æ–±—ä–µ–∫—Ç–æ–≤

## üîç **–î–∏–∞–≥–Ω–æ–∑:**

### –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞–π–¥–µ–Ω–∞! ‚ùå
–§—É–Ω–∫—Ü–∏—è `soft_delete_property` **–ù–ï –°–û–ó–î–ê–ù–ê** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Supabase.

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:
```
function_name          | exists | status
-----------------------|--------|------------------
archive_property       | true   | ‚úÖ –§—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
soft_delete_property   | false  | ‚ùå –§–£–ù–ö–¶–ò–Ø –ù–ï –ù–ê–ô–î–ï–ù–ê!
restore_property       | true   | ‚úÖ –§—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
```

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–ª "Delete" –Ω–∞ PropertyDrawer
2. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–ª `DELETE /api/saved-properties/[id]`
3. API –ø—ã—Ç–∞–ª—Å—è –≤—ã–∑–≤–∞—Ç—å `soft_delete_property()`
4. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ –æ—à–∏–±–∫—É** - —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!
5. –û–±—ä–µ–∫—Ç –Ω–µ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–ª—Å—è (–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª—è–ª—Å—è –Ω–∞—Å–æ–≤—Å–µ–º –∏–ª–∏ –æ—Å—Ç–∞–≤–∞–ª—Å—è)
6. Admin Panel –ø–æ–∫–∞–∑—ã–≤–∞–ª "Show Archived (0)"

---

## ‚úÖ **–†–µ—à–µ–Ω–∏–µ:**

### –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL-—Å–∫—Ä–∏–ø—Ç: `FIX_ARCHIVE_FUNCTIONS.sql`

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—Å—Ç —Ñ—É–Ω–∫—Ü–∏—é `soft_delete_property`, –∫–æ—Ç–æ—Ä–∞—è:
- ‚úÖ –ö–æ–ø–∏—Ä—É–µ—Ç –æ–±—ä–µ–∫—Ç –∏–∑ `saved_properties` ‚Üí `archived_properties`
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (—Ñ–æ—Ç–æ, –∫–æ–Ω—Ç–∞–∫—Ç—ã, –æ–ø–∏—Å–∞–Ω–∏–µ)
- ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `can_restore = TRUE`
- ‚úÖ –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–∏—á–∏–Ω—É –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –∏ –¥–∞—Ç—É
- ‚úÖ –í—ã—á–∏—Å–ª—è–µ—Ç —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –æ–±—ä–µ–∫—Ç –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
- ‚úÖ –£–¥–∞–ª—è–µ—Ç –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã

---

## üìã **–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:**

### 1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase SQL Editor
https://supabase.com ‚Üí –í–∞—à –ø—Ä–æ–µ–∫—Ç ‚Üí SQL Editor

### 2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç
–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ **`FIX_ARCHIVE_FUNCTIONS.sql`** –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
–î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏:
```
‚úÖ –§–£–ù–ö–¶–ò–Ø –°–û–ó–î–ê–ù–ê!
```

### 4. –¢–µ—Å—Ç–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
–°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—Å—Ç —Ç–µ—Å—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ ID –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```sql
SELECT soft_delete_property('ID_–°–Æ–î–ê'::UUID, 999999999, 'test_deletion');
```

### 5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```sql
-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 0
SELECT COUNT(*) FROM saved_properties WHERE telegram_user_id = 999999999;

-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 1
SELECT COUNT(*) FROM archived_properties WHERE telegram_user_id = 999999999;
```

### 6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ
1. –û–±–Ω–æ–≤–∏—Ç–µ `/admin/master-map` (F5)
2. –û—Ç–∫—Ä–æ–π—Ç–µ Admin Panel
3. –í–∫–ª—é—á–∏—Ç–µ "Show Archived"
4. –î–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "Show Archived (1)"
5. –°–µ—Ä—ã–π –º–∞—Ä–∫–µ—Ä –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –≤ Galle

---

## üéØ **–ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

### –î–æ:
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç Delete
  ‚Üì
API –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã–∑–≤–∞—Ç—å soft_delete_property()
  ‚Üì
‚ùå ERROR: function soft_delete_property does not exist
  ‚Üì
–û–±—ä–µ–∫—Ç –æ—Å—Ç–∞—ë—Ç—Å—è –∏–ª–∏ —É–¥–∞–ª—è–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
  ‚Üì
Show Archived (0) - –Ω–µ—á–µ–≥–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
```

### –ü–æ—Å–ª–µ:
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç Delete
  ‚Üì
API –≤—ã–∑—ã–≤–∞–µ—Ç soft_delete_property()
  ‚Üì
‚úÖ –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
  ‚Üì
–û–±—ä–µ–∫—Ç –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç—Å—è –≤ archived_properties
  ‚Üì
Show Archived (1) - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
  ‚Üì
–ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
```

---

## üìä **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**

### –§—É–Ω–∫—Ü–∏—è soft_delete_property:

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `property_id` (UUID) - ID –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
- `user_id` (BIGINT) - Telegram User ID (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤)
- `reason` (TEXT) - –ü—Ä–∏—á–∏–Ω–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'user_deleted')

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –æ–±—ä–µ–∫—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
2. –í—ã—á–∏—Å–ª—è–µ—Ç `days_active` = –¥–Ω–µ–π –º–µ–∂–¥—É created_at –∏ NOW()
3. –ö–æ–ø–∏—Ä—É–µ—Ç –í–°–ï –ø–æ–ª—è –≤ archived_properties:
   - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, —Ü–µ–Ω–∞, –æ–ø–∏—Å–∞–Ω–∏–µ, —Ñ–æ—Ç–æ
   - –ö–æ–Ω—Ç–∞–∫—Ç—ã, amenities, —Ç–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
   - Forward –¥–∞–Ω–Ω—ã–µ, message_link, raw_text
4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç:
   - `can_restore = TRUE` (–º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å)
   - `archive_reason = reason` (–ø—Ä–∏—á–∏–Ω–∞)
   - `archived_at = NOW()` (–≤—Ä–µ–º—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏)
   - `original_created_at = created_at` (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è)
5. –£–¥–∞–ª—è–µ—Ç –∏–∑ saved_properties
6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç TRUE –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ

**Security:**
- `SECURITY DEFINER` - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∞–º–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `user_id` - —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å
- `GRANT EXECUTE` - –¥–æ—Å—Ç—É–ø –¥–ª—è anon –∏ authenticated

---

## üìÅ **–°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----------|
| `FIX_ARCHIVE_FUNCTIONS.sql` | ‚ö° **–ì–õ–ê–í–ù–´–ô** - —Å–æ–∑–¥–∞—ë—Ç —Ñ—É–Ω–∫—Ü–∏—é |
| `–ë–´–°–¢–†–û–ï_–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï.md` | üìñ –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è |
| `–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê_–ê–†–•–ò–í–ê–¶–ò–ò.sql` | üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã |
| `–†–ï–®–ï–ù–ò–ï_–ü–†–û–ë–õ–ï–ú–´_–ê–†–•–ò–í–ê–¶–ò–ò.md` | üìä –≠—Ç–æ—Ç —Ñ–∞–π–ª - –ø–æ–ª–Ω–∞—è —Å–≤–æ–¥–∫–∞ |

---

## üîÆ **–ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:**

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –∞—Ä—Ö–∏–≤–∞—Ü–∏—è –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç:

### 1. –ö–Ω–æ–ø–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
–î–æ–±–∞–≤–∏—Ç—å –≤ PropertyDrawer –¥–ª—è –∞—Ä—Ö–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤:
```tsx
{property.isArchived && (
    <button onClick={handleRestore}>
        üîÑ Restore from Archive
    </button>
)}
```

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏–≤–∞—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏
Supabase Cron Job –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ —Å—Ç–∞—Ä—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤:
```sql
SELECT cron.schedule(
    'archive-old-properties',
    '0 0 * * *', -- –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å
    $$
    SELECT soft_delete_property(id, telegram_user_id, 'expired')
    FROM saved_properties
    WHERE created_at < NOW() - INTERVAL '30 days'
    $$
);
```

### 3. –§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–∏—á–∏–Ω–µ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
–í Admin Panel –¥–æ–±–∞–≤–∏—Ç—å dropdown:
- User deleted
- Expired
- Admin archived
- Spam/Invalid

### 4. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞—Ä—Ö–∏–≤–∞
–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏:
- –í—Å–µ–≥–æ –∞—Ä—Ö–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
- –î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- –°—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏ –æ–±—ä–µ–∫—Ç–∞
- –ß–∞—Å—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏

---

## ‚úÖ **–ß–µ–∫–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:**

- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω SQL-—Å–∫—Ä–∏–ø—Ç `FIX_ARCHIVE_FUNCTIONS.sql`
- [ ] –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ (‚úÖ –§–£–ù–ö–¶–ò–Ø –°–û–ó–î–ê–ù–ê!)
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç —Å–æ–∑–¥–∞–Ω –∏ —É–¥–∞–ª—ë–Ω
- [ ] –ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (0 –≤ saved, 1 –≤ archived)
- [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (F5)
- [ ] "Show Archived (1)" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0
- [ ] –°–µ—Ä—ã–π –º–∞—Ä–∫–µ—Ä –≤–∏–¥–µ–Ω –Ω–∞ –∫–∞—Ä—Ç–µ
- [ ] PropertyDrawer –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å [ARCHIVED]
- [ ] –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –±–µ–∑ –æ—à–∏–±–æ–∫

---

## üìû **–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**

**–ü–æ–∫–∞–∂–∏—Ç–µ –º–Ω–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**

1. ‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL (‚úÖ –§–£–ù–ö–¶–ò–Ø –°–û–ó–î–ê–ù–ê!)
2. ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏: `SELECT COUNT(*) FROM archived_properties;`
3. ‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç Admin Panel —Å "Show Archived (N)" –≥–¥–µ N > 0
4. ‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç –∫–∞—Ä—Ç—ã —Å —Å–µ—Ä—ã–º –º–∞—Ä–∫–µ—Ä–æ–º

–¢–æ–≥–¥–∞ —è –±—É–¥—É —É–≤–µ—Ä–µ–Ω —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç! üéâ

---

## üéâ **–ò—Ç–æ–≥:**

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è `soft_delete_property` –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ ‚Üí –∞—Ä—Ö–∏–≤–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–ø–æ–ª–Ω–∏—Ç—å `FIX_ARCHIVE_FUNCTIONS.sql` ‚Üí –≤—Å—ë –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç

**–í—Ä–µ–º—è:** 2-3 –º–∏–Ω—É—Ç—ã ‚ö°

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è! ‚ú®

---

**–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –∏ –ø–æ–∫–∞–∂–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã!** üöÄ
