---
import Layout from '../layouts/Layout.astro';
---

<Layout title="POI Validation Test">
  <main class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">üîç POI Validation System Test</h1>
    
    <div class="max-w-4xl mx-auto space-y-6">
      <!-- Test Instructions -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h2 class="text-xl font-bold text-blue-900 mb-3">üìã Test Instructions</h2>
        <p class="text-blue-800 mb-3">
          This page tests the POI validation system with Google Maps API.
        </p>
        <ol class="list-decimal list-inside space-y-2 text-sm text-blue-700">
          <li>Enter coordinates and optional POI information</li>
          <li>Click "Validate POI" to check against Google Maps</li>
          <li>Review validation results, issues, and suggestions</li>
          <li>Test different scenarios (valid/invalid coordinates, matching/mismatching names)</li>
        </ol>
      </div>

      <!-- Validation Test Container -->
      <div id="validation-test-container"></div>

      <!-- Test Scenarios -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">üß™ Test Scenarios</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <button
            class="test-scenario px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg text-left transition-colors"
            data-lat="6.0099"
            data-lng="80.2148"
            data-name="Unawatuna Beach"
            data-type="tourist_attraction"
          >
            <div class="font-bold text-gray-900">‚úÖ Valid: Unawatuna Beach</div>
            <div class="text-sm text-gray-600">Should match perfectly</div>
          </button>

          <button
            class="test-scenario px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg text-left transition-colors"
            data-lat="6.1384"
            data-lng="80.1019"
            data-name="Galle Fort"
            data-type="tourist_attraction"
          >
            <div class="font-bold text-gray-900">‚úÖ Valid: Galle Fort</div>
            <div class="text-sm text-gray-600">Historical landmark</div>
          </button>

          <button
            class="test-scenario px-4 py-3 bg-yellow-100 hover:bg-yellow-200 rounded-lg text-left transition-colors"
            data-lat="6.0099"
            data-lng="80.2148"
            data-name="Wrong Beach Name"
            data-type="tourist_attraction"
          >
            <div class="font-bold text-yellow-900">‚ö†Ô∏è Warning: Name Mismatch</div>
            <div class="text-sm text-yellow-700">Correct coords, wrong name</div>
          </button>

          <button
            class="test-scenario px-4 py-3 bg-red-100 hover:bg-red-200 rounded-lg text-left transition-colors"
            data-lat="0"
            data-lng="0"
            data-name="Invalid Location"
            data-type="point_of_interest"
          >
            <div class="font-bold text-red-900">‚ùå Invalid: Ocean Coordinates</div>
            <div class="text-sm text-red-700">No matching place</div>
          </button>

          <button
            class="test-scenario px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg text-left transition-colors"
            data-lat="5.9490"
            data-lng="80.5353"
            data-name="Mirissa Beach"
            data-type="tourist_attraction"
          >
            <div class="font-bold text-gray-900">‚úÖ Valid: Mirissa Beach</div>
            <div class="text-sm text-gray-600">Popular beach destination</div>
          </button>

          <button
            class="test-scenario px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg text-left transition-colors"
            data-lat="5.9733"
            data-lng="80.6270"
            data-name="Weligama Bay"
            data-type="natural_feature"
          >
            <div class="font-bold text-gray-900">‚úÖ Valid: Weligama Bay</div>
            <div class="text-sm text-gray-600">Surfing bay</div>
          </button>
        </div>
      </div>

      <!-- Manual Test Form -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">üéØ Manual Test</h2>
        <form id="manual-test-form" class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Latitude</label>
              <input
                type="number"
                id="manual-lat"
                step="0.000001"
                placeholder="6.0099"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
              />
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Longitude</label>
              <input
                type="number"
                id="manual-lng"
                step="0.000001"
                placeholder="80.2148"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
              />
            </div>
          </div>
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Place Name (optional)</label>
            <input
              type="text"
              id="manual-name"
              placeholder="Unawatuna Beach"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
            />
          </div>
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Type (optional)</label>
            <select
              id="manual-type"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
            >
              <option value="">-- Select Type --</option>
              <option value="lodging">Lodging</option>
              <option value="restaurant">Restaurant</option>
              <option value="tourist_attraction">Tourist Attraction</option>
              <option value="point_of_interest">Point of Interest</option>
              <option value="natural_feature">Natural Feature</option>
              <option value="establishment">Establishment</option>
            </select>
          </div>
          <button
            type="submit"
            class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors"
          >
            üîç Validate POI
          </button>
        </form>
      </div>

      <!-- Results will be displayed here -->
      <div id="validation-results"></div>
    </div>
  </main>
</Layout>

<script>
  import { validatePOI } from '../services/googleMapsValidation';

  // Test scenario buttons
  document.querySelectorAll('.test-scenario').forEach(button => {
    button.addEventListener('click', async (e) => {
      const btn = e.currentTarget as HTMLButtonElement;
      const lat = parseFloat(btn.dataset.lat || '0');
      const lng = parseFloat(btn.dataset.lng || '0');
      const name = btn.dataset.name || '';
      const type = btn.dataset.type || '';

      await runValidation(lat, lng, name, type);
    });
  });

  // Manual test form
  document.getElementById('manual-test-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const lat = parseFloat((document.getElementById('manual-lat') as HTMLInputElement).value);
    const lng = parseFloat((document.getElementById('manual-lng') as HTMLInputElement).value);
    const name = (document.getElementById('manual-name') as HTMLInputElement).value;
    const type = (document.getElementById('manual-type') as HTMLSelectElement).value;

    if (isNaN(lat) || isNaN(lng)) {
      alert('Please enter valid coordinates');
      return;
    }

    await runValidation(lat, lng, name, type);
  });

  async function runValidation(lat: number, lng: number, name: string, type: string) {
    const resultsDiv = document.getElementById('validation-results');
    if (!resultsDiv) return;

    // Show loading state
    resultsDiv.innerHTML = `
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
        <div class="animate-spin text-4xl mb-3">‚è≥</div>
        <div class="font-bold text-gray-900">Validating with Google Maps...</div>
        <div class="text-sm text-gray-600 mt-1">This may take a few seconds</div>
      </div>
    `;

    try {
      const result = await validatePOI(
        {
          coordinates: { lat, lng },
          name: name || undefined,
          type: type || undefined,
        },
        {
          strictMode: false,
          maxDistanceMeters: 100,
          requireGoogleMatch: false,
        }
      );

      // Display results
      const statusColor = result.isValid
        ? result.confidence >= 0.8
          ? 'green'
          : 'yellow'
        : 'red';

      resultsDiv.innerHTML = `
        <div class="bg-white border border-gray-200 rounded-lg p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-4">üìä Validation Results</h2>
          
          <div class="bg-${statusColor}-50 border border-${statusColor}-200 rounded-lg p-4 mb-4">
            <div class="flex items-center justify-between">
              <span class="text-lg font-bold text-${statusColor}-900">
                ${result.isValid ? '‚úÖ Valid' : '‚ùå Invalid'}
              </span>
              <div class="text-right">
                <div class="text-sm font-medium text-${statusColor}-900">
                  Confidence: ${Math.round(result.confidence * 100)}%
                </div>
                ${result.matchScore > 0 ? `
                  <div class="text-sm text-${statusColor}-700">
                    Match: ${Math.round(result.matchScore)}%
                  </div>
                ` : ''}
              </div>
            </div>
            ${result.distanceFromInput > 0 ? `
              <div class="text-sm mt-2 text-${statusColor}-800">
                üìç Distance: ${Math.round(result.distanceFromInput)}m
              </div>
            ` : ''}
          </div>

          ${result.placeDetails ? `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
              <h3 class="font-bold text-blue-900 mb-2">üìç Google Maps Match</h3>
              <div class="space-y-1 text-sm text-blue-800">
                <div><strong>Name:</strong> ${result.placeDetails.name}</div>
                <div><strong>Address:</strong> ${result.placeDetails.formatted_address}</div>
                <div><strong>Coordinates:</strong> ${result.placeDetails.geometry.location.lat.toFixed(6)}, ${result.placeDetails.geometry.location.lng.toFixed(6)}</div>
                ${result.placeDetails.rating ? `<div><strong>Rating:</strong> ‚≠ê ${result.placeDetails.rating}/5</div>` : ''}
                ${result.placeDetails.types ? `<div><strong>Types:</strong> ${result.placeDetails.types.slice(0, 3).join(', ')}</div>` : ''}
              </div>
            </div>
          ` : ''}

          ${result.issues.length > 0 ? `
            <div class="space-y-2 mb-4">
              <h3 class="font-bold text-gray-900">Issues Found:</h3>
              ${result.issues.map(issue => `
                <div class="bg-${issue.severity === 'error' ? 'red' : issue.severity === 'warning' ? 'yellow' : 'blue'}-100 border border-${issue.severity === 'error' ? 'red' : issue.severity === 'warning' ? 'yellow' : 'blue'}-200 rounded-lg p-3">
                  <div class="font-medium text-${issue.severity === 'error' ? 'red' : issue.severity === 'warning' ? 'yellow' : 'blue'}-900">
                    ${issue.severity === 'error' ? '‚ùå' : issue.severity === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'} ${issue.field}
                  </div>
                  <div class="text-sm text-${issue.severity === 'error' ? 'red' : issue.severity === 'warning' ? 'yellow' : 'blue'}-800">
                    ${issue.message}
                  </div>
                </div>
              `).join('')}
            </div>
          ` : ''}

          ${result.suggestions.length > 0 ? `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
              <h3 class="font-bold text-blue-900 mb-2">üí° Suggestions:</h3>
              <ul class="list-disc list-inside space-y-1 text-sm text-blue-800">
                ${result.suggestions.map(s => `<li>${s}</li>`).join('')}
              </ul>
            </div>
          ` : ''}

          <div class="mt-4 pt-4 border-t border-gray-200">
            <pre class="bg-gray-50 rounded p-3 text-xs overflow-auto">${JSON.stringify(result, null, 2)}</pre>
          </div>
        </div>
      `;
    } catch (error) {
      resultsDiv.innerHTML = `
        <div class="bg-red-50 border border-red-200 rounded-lg p-6">
          <h2 class="text-xl font-bold text-red-900 mb-2">‚ùå Validation Error</h2>
          <p class="text-red-700">${error instanceof Error ? error.message : 'Unknown error'}</p>
        </div>
      `;
    }
  }
</script>

<style>
  .container {
    max-width: 1200px;
  }
</style>
</Layout>
