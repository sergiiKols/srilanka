const P={types:["coordinates","name","address"],strictMode:!1,maxDistanceMeters:100,requireGoogleMatch:!0,minConfidence:.7},w="AIzaSyBpBqHcyk_X-ocdmmJzWZO-Ma0KJA3WeYw";function v(s,n,t,e){const c=s*Math.PI/180,o=t*Math.PI/180,r=(t-s)*Math.PI/180,l=(e-n)*Math.PI/180,d=Math.sin(r/2)*Math.sin(r/2)+Math.cos(c)*Math.cos(o)*Math.sin(l/2)*Math.sin(l/2);return 6371e3*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))}function y(s,n){const t=s.toLowerCase().trim(),e=n.toLowerCase().trim();if(t===e)return 1;const a=t.length>e.length?t:e,c=t.length>e.length?e:t;if(a.length===0)return 1;const o=_(a,c);return(a.length-o)/a.length}function _(s,n){const t=[];for(let e=0;e<=n.length;e++)t[e]=[e];for(let e=0;e<=s.length;e++)t[0][e]=e;for(let e=1;e<=n.length;e++)for(let a=1;a<=s.length;a++)n.charAt(e-1)===s.charAt(a-1)?t[e][a]=t[e-1][a-1]:t[e][a]=Math.min(t[e-1][a-1]+1,t[e][a-1]+1,t[e-1][a]+1);return t[n.length][s.length]}async function S(s){const{coordinates:n,name:t,type:e,expectedRadius:a=100}=s,c=Math.min(a,500),o=new URL("https://maps.googleapis.com/maps/api/place/nearbysearch/json");o.searchParams.set("location",`${n.lat},${n.lng}`),o.searchParams.set("radius",c.toString()),o.searchParams.set("key",w),e&&o.searchParams.set("type",e),t&&o.searchParams.set("keyword",t);try{const l=await(await fetch(o.toString())).json();if(l.status!=="OK"&&l.status!=="ZERO_RESULTS")throw new Error(`Google Places API error: ${l.status}`);const d=l.results||[];let h,u=0;if(t&&d.length>0)for(const i of d){const m=y(t,i.name),f=v(n.lat,n.lng,i.geometry.location.lat,i.geometry.location.lng),p=Math.max(0,1-f/c),g=m*.7+p*.3;g>u&&(u=g,h=i)}else d.length>0&&(h=d[0]);const M=d.filter(i=>i.place_id!==h?.place_id);return{places:d,bestMatch:h,alternatives:M}}catch(r){throw console.error("Error searching nearby places:",r),r}}async function $(s){const n=new URL("https://maps.googleapis.com/maps/api/place/details/json");n.searchParams.set("place_id",s),n.searchParams.set("fields","place_id,name,formatted_address,geometry,rating,user_ratings_total,types,photos,website,international_phone_number,opening_hours,reviews,price_level"),n.searchParams.set("key",w);try{const e=await(await fetch(n.toString())).json();if(e.status!=="OK")throw new Error(`Google Places API error: ${e.status}`);return e.result}catch(t){throw console.error("Error fetching place details:",t),t}}async function I(s,n){const t=[];(s<-90||s>90)&&t.push({severity:"error",field:"latitude",message:`Invalid latitude: ${s}. Must be between -90 and 90.`}),(n<-180||n>180)&&t.push({severity:"error",field:"longitude",message:`Invalid longitude: ${n}. Must be between -180 and 180.`});try{const e=new URL("https://maps.googleapis.com/maps/api/geocode/json");e.searchParams.set("latlng",`${s},${n}`),e.searchParams.set("key",w);const c=await(await fetch(e.toString())).json();c.status==="ZERO_RESULTS"?t.push({severity:"warning",field:"coordinates",message:"Coordinates do not correspond to a known location."}):c.status!=="OK"&&t.push({severity:"warning",field:"coordinates",message:`Could not verify coordinates: ${c.status}`})}catch{t.push({severity:"info",field:"coordinates",message:"Could not verify coordinates with Google Maps."})}return{isValid:!t.some(e=>e.severity==="error"),issues:t}}async function b(s,n={}){const t={...P,...n},e=[],a=[];let c=0,o=0,r,l=0;if(t.types.includes("coordinates")){const i=await I(s.coordinates.lat,s.coordinates.lng);e.push(...i.issues)}try{const i=await S(s);if(i.bestMatch){if(r=await $(i.bestMatch.place_id),l=v(s.coordinates.lat,s.coordinates.lng,r.geometry.location.lat,r.geometry.location.lng),l>t.maxDistanceMeters&&(e.push({severity:"warning",field:"coordinates",message:`Location is ${Math.round(l)}m away from nearest matching place.`,suggestedValue:{lat:r.geometry.location.lat,lng:r.geometry.location.lng}}),a.push(`Consider using coordinates: ${r.geometry.location.lat}, ${r.geometry.location.lng}`)),s.name&&t.types.includes("name")){const g=y(s.name,r.name);c=g*100,g<.5?(e.push({severity:"warning",field:"name",message:`Name "${s.name}" doesn't match found place "${r.name}"`,suggestedValue:r.name}),a.push(`Consider using name: "${r.name}"`)):g<.8&&a.push(`Similar place found: "${r.name}"`)}else c=70;s.address&&t.types.includes("address")&&y(s.address,r.formatted_address)<.5&&e.push({severity:"info",field:"address",message:"Address differs from Google Maps data",suggestedValue:r.formatted_address});const m=(r.rating||0)>=4,f=(r.user_ratings_total||0)>=5,p=(r.photos?.length||0)>0;o=.4,c>80?o+=.3:c>60?o+=.2:c>40&&(o+=.1),l<50?o+=.2:l<100&&(o+=.1),m&&(o+=.05),f&&(o+=.05),p&&(o+=.05)}else t.requireGoogleMatch?(e.push({severity:"error",field:"general",message:"No matching place found in Google Maps"}),a.push("Check coordinates and place name"),o=0):(o=.3,a.push("No matching place found in Google Maps - manual verification recommended"));if(i.alternatives.length>0){const m=i.alternatives.slice(0,3).map(f=>f.name).join(", ");a.push(`Nearby alternatives: ${m}`)}}catch(i){e.push({severity:"error",field:"general",message:`Validation failed: ${i instanceof Error?i.message:"Unknown error"}`}),o=0}const d=e.some(i=>i.severity==="error"),h=e.some(i=>i.severity==="warning"),u=o>=t.minConfidence;return{isValid:!d&&u&&(!t.strictMode||!h),confidence:o,matchScore:c,issues:e,suggestions:a,placeDetails:r,distanceFromInput:l}}export{b as v};
