---
/**
 * –°—Ç—Ä–∞–Ω–∏—Ü–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram Bot
 * URL: /admin/forms/telegram/settings
 */

export const prerender = false;

import Layout from "../../../../layouts/Layout.astro";
import AdminLayout from "../../../../components/admin/AdminLayout";
import ErrorBoundary from "../../../../components/ErrorBoundary";
import { requireAdminPage } from "../../../../lib/auth";

const authError = await requireAdminPage(Astro);
if (authError) return authError;
---

<Layout title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram Bot">
  <AdminLayout
    client:load
    title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram Bot"
    subtitle="–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Bot Token –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
  >
    <div class="settings-page">
      <ErrorBoundary client:load>
        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
        <div class="info-panel">
          <h3>üìö –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Telegram –±–æ—Ç–∞</h3>
          <ol>
            <li>
              –û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://t.me/BotFather" target="_blank"
                >@BotFather</a
              > –≤ Telegram
            </li>
            <li>
              –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É <code>/newbot</code> –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞
            </li>
            <li>–°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –∏ –ø–æ–ª—É—á–∏—Ç–µ <strong>Bot Token</strong></li>
            <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –Ω–∏–∂–µ</li>
            <li>
              –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Web App URL –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–æ—Ä–º—ã: <code
                >https://your-domain.com/telegram-app?form_id=XXX</code>
            </li>
          </ol>
        </div>

        <!-- –§–æ—Ä–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
        <div class="settings-form">
          <h3>‚öôÔ∏è –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>

          <div class="form-group">
            <label for="default-bot-token">
              <strong>Default Bot Token</strong>
              <span class="help-text"
                >–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö —Ñ–æ—Ä–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</span
              >
            </label>
            <div class="input-with-button">
              <input
                type="password"
                id="default-bot-token"
                placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11"
                class="input-field"
              />
              <button id="toggle-token" class="btn-icon" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å"
                >üëÅÔ∏è</button
              >
            </div>
            <small class="help-text"
              >–¢–æ–∫–µ–Ω –±—É–¥–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º</small
            >
          </div>

          <div class="form-group">
            <label for="default-chat-id">
              <strong>Default Chat ID</strong>
              <span class="help-text"
                >–ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</span
              >
            </label>
            <input
              type="text"
              id="default-chat-id"
              placeholder="-1001234567890"
              class="input-field"
            />
            <small class="help-text">
              –ü–æ–ª—É—á–∏—Ç—å Chat ID: <a
                href="https://t.me/userinfobot"
                target="_blank">@userinfobot</a
              >
            </small>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="enable-notifications" />
              <strong>–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö</strong>
            </label>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="enable-rate-limiting" checked />
              <strong>–í–∫–ª—é—á–∏—Ç—å rate limiting (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞)</strong>
            </label>
            <small class="help-text"
              >–ú–∞–∫—Å–∏–º—É–º 5 –∑–∞—è–≤–æ–∫ –∑–∞ 5 –º–∏–Ω—É—Ç —Å –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</small
            >
          </div>

          <div class="form-actions">
            <button id="save-settings" class="btn-primary"
              >üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button
            >
            <button id="test-connection" class="btn-secondary"
              >üß™ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button
            >
          </div>

          <div id="message" class="message hidden"></div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-panel">
          <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h3>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="total-forms">-</div>
              <div class="stat-label">–í—Å–µ–≥–æ —Ñ–æ—Ä–º</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="active-forms">-</div>
              <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–æ—Ä–º</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="total-submissions">-</div>
              <div class="stat-label">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="today-submissions">-</div>
              <div class="stat-label">–ó–∞—è–≤–æ–∫ —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
          </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Ñ–æ—Ä–º —Å –∏—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ -->
        <div class="forms-list">
          <h3>üìã –§–æ—Ä–º—ã –∏ –∏—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
          <div id="forms-table">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ä–º...</div>
          </div>
        </div>
      </ErrorBoundary>
    </div>

    <script>
      // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
      async function loadSettings() {
        try {
          // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ä–º—ã –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
          const formsResponse = await fetch("/api/admin/forms");
          const formsResult = await formsResponse.json();

          if (formsResult.success) {
            const forms = formsResult.data;
            document.getElementById("total-forms").textContent = forms.length;
            document.getElementById("active-forms").textContent = forms.filter(
              (f) => f.is_active,
            ).length;

            renderFormsTable(forms);
          }

          // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞—è–≤–æ–∫
          const submissionsResponse = await fetch(
            "/api/admin/forms/submissions?limit=1000",
          );
          const submissionsResult = await submissionsResponse.json();

          if (submissionsResult.success) {
            const total = submissionsResult.pagination.total;
            document.getElementById("total-submissions").textContent = total;

            // –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –∑–∞—è–≤–∫–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
            const today = new Date().toISOString().split("T")[0];
            const todayCount = submissionsResult.data.filter((s) =>
              s.created_at.startsWith(today),
            ).length;
            document.getElementById("today-submissions").textContent =
              todayCount;
          }
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:", error);
        }
      }

      function renderFormsTable(forms) {
        const container = document.getElementById("forms-table");

        if (forms.length === 0) {
          container.innerHTML = '<div class="empty">–§–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
          return;
        }

        const table = `
          <table class="data-table">
            <thead>
              <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã</th>
                <th>Chat ID</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>Web App URL</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody>
              ${forms
                .map((form) => {
                  const webAppUrl = `${window.location.origin}/telegram-app?form_id=${form.id}`;
                  return `
                  <tr>
                    <td><strong>${form.title}</strong></td>
                    <td>${form.chat_id || "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é"}</td>
                    <td>
                      <span class="status-badge ${form.is_active ? "active" : "inactive"}">
                        ${form.is_active ? "‚úÖ –ê–∫—Ç–∏–≤–Ω–∞" : "‚ùå –ù–µ–∞–∫—Ç–∏–≤–Ω–∞"}
                      </span>
                    </td>
                    <td>
                      <code class="code-snippet">${webAppUrl}</code>
                      <button class="btn-icon" onclick="copyToClipboard('${webAppUrl}')" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                        üìã
                      </button>
                    </td>
                    <td>
                      <a href="/admin/forms/telegram/${form.id}" class="btn-sm">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    </td>
                  </tr>
                `;
                })
                .join("")}
            </tbody>
          </table>
        `;

        container.innerHTML = table;
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ç–æ–∫–µ–Ω
      document.getElementById("toggle-token").addEventListener("click", () => {
        const input = document.getElementById("default-bot-token");
        input.type = input.type === "password" ? "text" : "password";
      });

      // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      document
        .getElementById("save-settings")
        .addEventListener("click", async () => {
          const botToken = document.getElementById("default-bot-token").value;
          const chatId = document.getElementById("default-chat-id").value;
          const enableNotifications = document.getElementById(
            "enable-notifications",
          ).checked;
          const enableRateLimiting = document.getElementById(
            "enable-rate-limiting",
          ).checked;

          if (!botToken) {
            showMessage("–£–∫–∞–∂–∏—Ç–µ Bot Token", "error");
            return;
          }

          try {
            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
            // –ü–æ–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏–º –≤ localStorage –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
            localStorage.setItem("telegram_bot_token", botToken);
            localStorage.setItem("telegram_chat_id", chatId);
            localStorage.setItem("telegram_notifications", enableNotifications);
            localStorage.setItem("telegram_rate_limiting", enableRateLimiting);

            showMessage("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã", "success");
          } catch (error) {
            showMessage("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫", "error");
            console.error(error);
          }
        });

      // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
      document
        .getElementById("test-connection")
        .addEventListener("click", async () => {
          const botToken = document.getElementById("default-bot-token").value;

          if (!botToken) {
            showMessage("–£–∫–∞–∂–∏—Ç–µ Bot Token –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏", "error");
            return;
          }

          try {
            const response = await fetch(
              `https://api.telegram.org/bot${botToken}/getMe`,
            );
            const result = await response.json();

            if (result.ok) {
              showMessage(
                `‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ! –ë–æ—Ç: @${result.result.username}`,
                "success",
              );
            } else {
              showMessage(
                "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " + result.description,
                "error",
              );
            }
          } catch (error) {
            showMessage("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Telegram API", "error");
            console.error(error);
          }
        });

      function showMessage(text, type) {
        const message = document.getElementById("message");
        message.textContent = text;
        message.className = `message ${type}`;
        message.classList.remove("hidden");

        setTimeout(() => {
          message.classList.add("hidden");
        }, 5000);
      }

      window.copyToClipboard = (text) => {
        navigator.clipboard.writeText(text);
        showMessage("‚úÖ URL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞", "success");
      };

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      loadSettings();

      // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      const savedToken = localStorage.getItem("telegram_bot_token");
      const savedChatId = localStorage.getItem("telegram_chat_id");
      const savedNotifications =
        localStorage.getItem("telegram_notifications") === "true";
      const savedRateLimiting =
        localStorage.getItem("telegram_rate_limiting") !== "false";

      if (savedToken)
        document.getElementById("default-bot-token").value = savedToken;
      if (savedChatId)
        document.getElementById("default-chat-id").value = savedChatId;
      document.getElementById("enable-notifications").checked =
        savedNotifications;
      document.getElementById("enable-rate-limiting").checked =
        savedRateLimiting;
    </script>

    <style>
      .settings-page {
        max-width: 1200px;
      }

      .info-panel {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
      }

      .info-panel h3 {
        margin: 0 0 12px 0;
        color: #1e40af;
      }

      .info-panel ol {
        margin: 0;
        padding-left: 20px;
      }

      .info-panel li {
        margin-bottom: 8px;
        line-height: 1.6;
      }

      .info-panel code {
        background: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 13px;
      }

      .settings-form,
      .stats-panel,
      .forms-list {
        background: white;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 24px;
      }

      .settings-form h3,
      .stats-panel h3,
      .forms-list h3 {
        margin: 0 0 20px 0;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #374151;
      }

      .help-text {
        display: block;
        font-size: 13px;
        color: #6b7280;
        margin-top: 4px;
      }

      .input-field {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        font-family: monospace;
      }

      .input-with-button {
        display: flex;
        gap: 8px;
      }

      .input-with-button .input-field {
        flex: 1;
      }

      .form-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
      }

      .btn-primary,
      .btn-secondary,
      .btn-sm,
      .btn-icon {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #3b82f6;
        color: white;
      }

      .btn-primary:hover {
        background: #2563eb;
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #374151;
      }

      .btn-secondary:hover {
        background: #e5e7eb;
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
        background: #3b82f6;
        color: white;
        text-decoration: none;
        display: inline-block;
      }

      .btn-icon {
        padding: 8px;
        background: transparent;
        font-size: 18px;
      }

      .btn-icon:hover {
        background: #f3f4f6;
      }

      .message {
        margin-top: 16px;
        padding: 12px;
        border-radius: 6px;
        font-size: 14px;
      }

      .message.success {
        background: #d1fae5;
        color: #065f46;
      }

      .message.error {
        background: #fee2e2;
        color: #991b1b;
      }

      .message.hidden {
        display: none;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .stat-item {
        text-align: center;
        padding: 20px;
        background: #f9fafb;
        border-radius: 8px;
      }

      .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 8px;
      }

      .stat-label {
        font-size: 14px;
        color: #6b7280;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table th {
        background: #f9fafb;
        padding: 12px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        color: #6b7280;
        border-bottom: 2px solid #e5e7eb;
      }

      .data-table td {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 14px;
      }

      .code-snippet {
        font-family: monospace;
        font-size: 12px;
        background: #f3f4f6;
        padding: 4px 8px;
        border-radius: 4px;
        max-width: 300px;
        display: inline-block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-badge.active {
        background: #d1fae5;
        color: #065f46;
      }

      .status-badge.inactive {
        background: #fee2e2;
        color: #991b1b;
      }

      .loading,
      .empty {
        text-align: center;
        padding: 40px;
        color: #6b7280;
      }
    </style>
  </AdminLayout>
</Layout>
