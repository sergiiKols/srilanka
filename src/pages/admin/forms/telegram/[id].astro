---
/**
 * –ê–¥–º–∏–Ω —Å—Ç—Ä–∞–Ω–∏—Ü–∞: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram —Ñ–æ—Ä–º—ã
 * URL: /admin/forms/telegram/[id]
 */

export const prerender = false;

import AdminLayout from "../../../../components/admin/AdminLayout.tsx";
import FormBuilder from "../../../../components/admin/FormBuilder.tsx";
import FormPreview from "../../../../components/admin/FormPreview.tsx";
import ErrorBoundary from "../../../../components/ErrorBoundary.tsx";
import { requireAdminPage } from "../../../../lib/auth";

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞
const authResult = await requireAdminPage(Astro);
if (authResult.redirect) return authResult.redirect;

const user = authResult.user;
const formId = Astro.params.id;

if (!formId || formId === "new") {
  return Astro.redirect("/admin/forms/telegram/new");
}
---

<AdminLayout title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã" user={user}>
  <div class="max-w-5xl mx-auto space-y-6">
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="flex items-center gap-2 text-sm text-gray-600">
      <a href="/admin/forms/telegram" class="hover:text-blue-600">–§–æ—Ä–º—ã</a>
      <span>/</span>
      <span class="text-gray-900">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Ñ–æ—Ä–º—ã -->
    <div class="bg-white rounded-lg border border-gray-200 p-6">
      <h1 class="text-2xl font-bold mb-6">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä–º—ã</h1>

      <form id="form-settings" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã *</label>
          <input
            type="text"
            id="form-title"
            name="title"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞—è–≤–∫–∞ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é"
          />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea
            id="form-description"
            name="description"
            rows="3"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã"></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1"
            >–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏</label
          >
          <input
            type="text"
            id="form-submit-text"
            name="submit_text"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="–û—Ç–ø—Ä–∞–≤–∏—Ç—å"
          />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Telegram Chat ID</label>
          <input
            type="text"
            id="form-chat-id"
            name="chat_id"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: -1001234567890"
          />
          <p class="text-xs text-gray-500 mt-1">
            ID —á–∞—Ç–∞ –∏–ª–∏ –∫–∞–Ω–∞–ª–∞, –∫—É–¥–∞ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
          </p>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1"
            >–®–∞–±–ª–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è *</label
          >
          <textarea
            id="form-message-template"
            name="message_template"
            rows="6"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
            placeholder="üÜï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç {firstName}

–ò–º—è: {name}
Email: {email}

ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {userId}"
          ></textarea>
          <p class="text-xs text-gray-500 mt-1">
            –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã: {firstName}, {lastName}, {username}, {
              userId
            }, –∞ —Ç–∞–∫–∂–µ ID –ª—é–±—ã—Ö –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
          </p>
        </div>

        <div class="flex items-center">
          <input
            type="checkbox"
            id="form-is-active"
            name="is_active"
            class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
          />
          <label for="form-is-active" class="ml-2 text-sm">
            –§–æ—Ä–º–∞ –∞–∫—Ç–∏–≤–Ω–∞ (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞—è–≤–∫–∏)
          </label>
        </div>

        <div class="flex gap-3 pt-4">
          <button
            type="submit"
            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
          </button>
          <a
            href={`/admin/forms/telegram/${formId}/submissions`}
            class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
          >
            üì® –ó–∞—è–≤–∫–∏
          </a>
          <a
            href="/admin/forms/telegram"
            class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
          >
            ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
          </a>
        </div>
      </form>
    </div>

    <!-- –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø–æ–ª–µ–π —Å preview -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Form Builder -->
      <div class="bg-white rounded-lg border border-gray-200 p-6">
        <h2 class="text-xl font-semibold mb-4">–ü–æ–ª—è —Ñ–æ—Ä–º—ã</h2>
        <ErrorBoundary client:load>
          <FormBuilder formId={formId} client:load />
        </ErrorBoundary>
      </div>

      <!-- Form Preview -->
      <div class="bg-white rounded-lg border border-gray-200 p-6">
        <h2 class="text-xl font-semibold mb-4">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h2>
        <div id="form-preview-container">
          <ErrorBoundary client:load>
            <FormPreview fields={[]} client:load />
          </ErrorBoundary>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–µ–≤—å—é –∏ —Å—Å—ã–ª–∫–∞ -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
      <h3 class="font-bold text-blue-900 mb-3">üîó –°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ä–º—É</h3>
      <div class="bg-white rounded p-3 font-mono text-sm break-all">
        <span id="form-url"></span>
      </div>
      <p class="text-sm text-blue-700 mt-2">
        –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤–∞—à–µ–≥–æ Telegram –±–æ—Ç–∞ (Web App URL)
      </p>
    </div>
  </div>

  <script define:vars={{ formId }}>
    let currentForm = null;

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ä–º—ã
    async function loadForm() {
      try {
        const response = await fetch(`/api/admin/forms/${formId}`);
        const result = await response.json();

        if (result.success && result.data) {
          currentForm = result.data;

          // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
          document.getElementById("form-title").value = currentForm.title || "";
          document.getElementById("form-description").value =
            currentForm.description || "";
          document.getElementById("form-submit-text").value =
            currentForm.submit_text || "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
          document.getElementById("form-chat-id").value =
            currentForm.chat_id || "";
          document.getElementById("form-message-template").value =
            currentForm.message_template || "";
          document.getElementById("form-is-active").checked =
            currentForm.is_active || false;

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º URL
          const formUrl = `${window.location.origin}/telegram-app?form_id=${formId}`;
          document.getElementById("form-url").textContent = formUrl;
        } else {
          alert("–§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
          window.location.href = "/admin/forms/telegram";
        }
      } catch (error) {
        console.error("Load form error:", error);
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ä–º—ã");
      }
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    document
      .getElementById("form-settings")
      .addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        const data = {
          title: formData.get("title"),
          description: formData.get("description"),
          submit_text: formData.get("submit_text"),
          chat_id: formData.get("chat_id"),
          message_template: formData.get("message_template"),
          is_active: formData.get("is_active") === "on",
        };

        try {
          const response = await fetch(`/api/admin/forms/${formId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (result.success) {
            alert("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
            loadForm();
          } else {
            alert("‚ùå –û—à–∏–±–∫–∞: " + (result.error?.message || "Unknown error"));
          }
        } catch (error) {
          console.error("Save error:", error);
          alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        }
      });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadForm();
  </script>
</AdminLayout>
