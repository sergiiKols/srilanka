---
/**
 * –°—Ç—Ä–∞–Ω–∏—Ü–∞: –í—Å–µ –∑–∞—è–≤–∫–∏ —Å–æ –≤—Å–µ—Ö Telegram —Ñ–æ—Ä–º
 * URL: /admin/forms/telegram/submissions
 */

import Layout from '../../../../layouts/Layout.astro';
import AdminLayout from '../../../../components/admin/AdminLayout';
import ErrorBoundary from '../../../../components/ErrorBoundary';
import { requireAdminPage } from '../../../../lib/auth';

const authError = await requireAdminPage(Astro);
if (authError) return authError;
---

<Layout title="–í—Å–µ –∑–∞—è–≤–∫–∏ - Telegram Forms">
  <AdminLayout 
    client:load
    title="–í—Å–µ –∑–∞—è–≤–∫–∏"
    subtitle="–ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫ —Å–æ –≤—Å–µ—Ö Telegram —Ñ–æ—Ä–º"
  >
    <div class="submissions-page">
      <!-- –§–∏–ª—å—Ç—Ä—ã -->
      <div class="filters-panel">
        <div class="filter-group">
          <label for="form-filter">–§–æ—Ä–º–∞:</label>
          <select id="form-filter" class="filter-select">
            <option value="">–í—Å–µ —Ñ–æ—Ä–º—ã</option>
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
          </select>
        </div>
        
        <div class="filter-group">
          <label for="status-filter">–°—Ç–∞—Ç—É—Å:</label>
          <select id="status-filter" class="filter-select">
            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option value="received">–ü–æ–ª—É—á–µ–Ω–∞</option>
            <option value="processing">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
            <option value="sent">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</option>
            <option value="error">–û—à–∏–±–∫–∞</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="date-from">–î–∞—Ç–∞ –æ—Ç:</label>
          <input type="date" id="date-from" class="filter-input" />
        </div>
        
        <div class="filter-group">
          <label for="date-to">–î–∞—Ç–∞ –¥–æ:</label>
          <input type="date" id="date-to" class="filter-input" />
        </div>
        
        <button id="apply-filters" class="btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button id="reset-filters" class="btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</button>
        <button id="export-csv" class="btn-success">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
      </div>

      <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞—è–≤–æ–∫ -->
      <div class="table-container">
        <ErrorBoundary client:load>
          <div id="submissions-table">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...</div>
          </div>
        </ErrorBoundary>
      </div>

      <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
      <div class="pagination">
        <button id="prev-page" class="btn-secondary" disabled>‚Üê –ù–∞–∑–∞–¥</button>
        <span id="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1</span>
        <button id="next-page" class="btn-secondary">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
      </div>
    </div>

    <script>
      // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
      let currentPage = 1;
      let currentFilters = {};
      let totalPages = 1;

      async function loadSubmissions() {
        const params = new URLSearchParams({
          page: currentPage,
          limit: 50,
          ...currentFilters
        });

        try {
          const response = await fetch(`/api/admin/forms/submissions?${params}`);
          const result = await response.json();

          if (result.success) {
            renderTable(result.data);
            updatePagination(result.pagination);
          } else {
            showError(result.error.message);
          }
        } catch (error) {
          showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
          console.error(error);
        }
      }

      function renderTable(submissions) {
        const container = document.getElementById('submissions-table');
        
        if (submissions.length === 0) {
          container.innerHTML = '<div class="empty">–ó–∞—è–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
          return;
        }

        const table = `
          <table class="data-table">
            <thead>
              <tr>
                <th>–§–æ—Ä–º–∞</th>
                <th>–ò–º—è</th>
                <th>Telegram ID</th>
                <th>–î–∞–Ω–Ω—ã–µ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–∞—Ç–∞</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody>
              ${submissions.map(s => `
                <tr>
                  <td><strong>${s.form_configs?.title || 'N/A'}</strong></td>
                  <td>${s.first_name || ''} ${s.last_name || ''}</td>
                  <td>@${s.username || s.user_id}</td>
                  <td>
                    <button class="btn-sm" onclick="viewData('${s.id}')">
                      –ü—Ä–æ—Å–º–æ—Ç—Ä
                    </button>
                  </td>
                  <td>
                    <span class="status-badge status-${s.status}">
                      ${getStatusLabel(s.status)}
                    </span>
                  </td>
                  <td>${new Date(s.created_at).toLocaleString('ru-RU')}</td>
                  <td>
                    <button class="btn-icon" onclick="deleteSubmission('${s.id}')" title="–£–¥–∞–ª–∏—Ç—å">
                      üóëÔ∏è
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        
        container.innerHTML = table;
      }

      function getStatusLabel(status) {
        const labels = {
          received: '–ü–æ–ª—É—á–µ–Ω–∞',
          processing: '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
          sent: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞',
          error: '–û—à–∏–±–∫–∞'
        };
        return labels[status] || status;
      }

      function updatePagination(pagination) {
        totalPages = pagination.pages;
        document.getElementById('page-info').textContent = 
          `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages} (–í—Å–µ–≥–æ: ${pagination.total})`;
        
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = currentPage === totalPages;
      }

      function showError(message) {
        const container = document.getElementById('submissions-table');
        container.innerHTML = `<div class="error">${message}</div>`;
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      document.getElementById('apply-filters').addEventListener('click', () => {
        currentFilters = {
          form_id: document.getElementById('form-filter').value,
          status: document.getElementById('status-filter').value,
          date_from: document.getElementById('date-from').value,
          date_to: document.getElementById('date-to').value,
        };
        currentPage = 1;
        loadSubmissions();
      });

      document.getElementById('reset-filters').addEventListener('click', () => {
        currentFilters = {};
        document.getElementById('form-filter').value = '';
        document.getElementById('status-filter').value = '';
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';
        currentPage = 1;
        loadSubmissions();
      });

      document.getElementById('export-csv').addEventListener('click', async () => {
        const params = new URLSearchParams({ ...currentFilters, export: 'csv' });
        window.location.href = `/api/admin/forms/submissions?${params}`;
      });

      document.getElementById('prev-page').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          loadSubmissions();
        }
      });

      document.getElementById('next-page').addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          loadSubmissions();
        }
      });

      // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
      window.viewData = (id) => {
        // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        alert('–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∏: ' + id);
      };

      window.deleteSubmission = async (id) => {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) return;
        
        try {
          const response = await fetch(`/api/admin/submissions/${id}`, {
            method: 'DELETE'
          });
          const result = await response.json();
          
          if (result.success) {
            loadSubmissions();
          } else {
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + result.error.message);
          }
        } catch (error) {
          alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
          console.error(error);
        }
      };

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–æ—Ä–º –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
      async function loadForms() {
        try {
          const response = await fetch('/api/admin/forms');
          const result = await response.json();
          
          if (result.success) {
            const select = document.getElementById('form-filter');
            result.data.forEach(form => {
              const option = document.createElement('option');
              option.value = form.id;
              option.textContent = form.title;
              select.appendChild(option);
            });
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ä–º:', error);
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      loadForms();
      loadSubmissions();
    </script>

    <style>
      .submissions-page {
        max-width: 1400px;
      }

      .filters-panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: end;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .filter-group label {
        font-size: 13px;
        font-weight: 500;
        color: #666;
      }

      .filter-select,
      .filter-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        min-width: 150px;
      }

      .table-container {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table th {
        background: #f8f9fa;
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        color: #666;
        border-bottom: 2px solid #e5e7eb;
      }

      .data-table td {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 14px;
      }

      .data-table tbody tr:hover {
        background: #f8f9fa;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-received {
        background: #dbeafe;
        color: #1e40af;
      }

      .status-processing {
        background: #fef3c7;
        color: #92400e;
      }

      .status-sent {
        background: #d1fae5;
        color: #065f46;
      }

      .status-error {
        background: #fee2e2;
        color: #991b1b;
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
        padding: 20px;
        background: white;
        border-radius: 8px;
      }

      .btn-primary,
      .btn-secondary,
      .btn-success,
      .btn-sm,
      .btn-icon {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #3b82f6;
        color: white;
      }

      .btn-primary:hover {
        background: #2563eb;
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #374151;
      }

      .btn-secondary:hover {
        background: #e5e7eb;
      }

      .btn-secondary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      .btn-sm {
        padding: 4px 12px;
        font-size: 13px;
      }

      .btn-icon {
        padding: 6px;
        background: transparent;
        font-size: 16px;
      }

      .btn-icon:hover {
        background: #f3f4f6;
      }

      .loading,
      .empty,
      .error {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error {
        color: #dc2626;
      }
    </style>
  </AdminLayout>
</Layout>
